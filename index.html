<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE 4-Stage Syllabus Progress Tracker (Auto-Save)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }

        /* Styling for the segmented control labels */
        .radio-stage input[type="radio"] { position: absolute; opacity: 0; width: 0; height: 0; }
        .radio-stage label {
            cursor: pointer; padding: 4px 6px; font-size: 11px; font-weight: 500; text-align: center;
            border-radius: 4px; transition: all 0.2s; color: #6b7280; white-space: nowrap;
        }
        /* Updated color styles for each stage */
        .radio-stage input[type="radio"]:checked + label { color: white; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); }
        .radio-stage input[type="radio"].stage-0:checked + label { background-color: #94a3b8; } /* Reset - Gray */
        .radio-stage input[type="radio"].stage-1:checked + label { background-color: #f59e0b; } /* Lecture - Yellow */
        .radio-stage input[type="radio"].stage-2:checked + label { background-color: #ea580c; } /* Practice - Orange */
        .radio-stage input[type="radio"].stage-3:checked + label { background-color: #9333ea; } /* PYQ - Purple */
        .radio-stage input[type="radio"].stage-4:checked + label { background-color: #10b981; } /* Revision - Green */
        
        /* Notification Toast Container */
        #notification-container {
            position: fixed; top: 20px; right: 20px; z-index: 60;
            max-width: 90%; width: 350px;
        }
        .notification-toast {
            animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-in forwards 4s;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }

    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // --- HARDCODED FIREBASE CONFIGURATION (Using the configuration you provided) ---
        const HARDCODED_FIREBASE_CONFIG = { 
 Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyB9wE0qIEvaueXJzLyIQQmvhyGJC6k-j94", 
 Â  Â  Â  Â  Â  Â  authDomain: "jee-tracker-ead00.firebaseapp.com", 
 Â  Â  Â  Â  Â  Â  projectId: "jee-tracker-ead00", 
 Â  Â  Â  Â  Â  Â  storageBucket: "jee-tracker-ead00.firebasestorage.app", 
 Â  Â  Â  Â  Â  Â  messagingSenderId: "818054839055", 
 Â  Â  Â  Â  Â  Â  appId: "1:818054839055:web:139434c214d335247e5c7a" 
        };

        // --- GLOBAL FIREBASE/APP VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : HARDCODED_FIREBASE_CONFIG.projectId;
        const firebaseConfig = HARDCODED_FIREBASE_CONFIG;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let userProgress = {}; 
        let totalTopicsCount = 0;
        let userProfile = { name: 'Anonymous User', avatar: 'ðŸš€' }; 

        const AVATAR_EMOJIS = ['ðŸ¶', 'ðŸ±', 'ðŸ¦Š', 'ðŸ»', 'ðŸ¼', 'ðŸ¨', 'ðŸ…', 'ðŸ˜', 'ðŸ’', 'ðŸ¦–', 'ðŸ¦‹', 'ðŸ¦‰', 'ðŸ¢', 'ðŸŽ', 'ðŸ“', 'ðŸ', 'ðŸ‰', 'ðŸ¥', 'ðŸ¥­', 'ðŸ‡'];
        
        // Stages: 0=Not Started, 1=Lecture, 2=Practice, 3=PYQ, 4=Revision
        const PROGRESS_STAGES = [
            { id: 0, label: 'None', key: 'none', color: 'bg-slate-500' },
            { id: 1, label: 'Lecture', key: 'lecture', color: 'bg-yellow-500' },
            { id: 2, label: 'Practice', key: 'practice', color: 'bg-orange-500' },
            { id: 3, label: 'PYQ', key: 'pyq', color: 'bg-purple-500' },
            { id: 4, label: 'Revision', key: 'revision', color: 'bg-green-500' }
        ];

        // --- CORE SYLLABUS STRUCTURE (using the simplified list from the existing file) ---
        const JEE_SYLLABUS = {
            Physics: [
                { name: "Mechanics", topics: ["Units, Dimensions & Errors","Errors and measurements", "Motion in 1D","Motion in 2D", "Newton's Laws of Motion (NLM)","Work Power Energy","Centre of mass", "Rotational Motion","Mechanical Properties of Solid","Mechanical Properties of Fluid"] },
                { name: "Thermodynamics", topics: ["Thermal Properties", "Thermodynamics & KTG"] },
                { name: "Waves", topics: ["SHM", "Waves",] },
                { name: "Electro-Magnetism", topics: ["Electrostatics and electrostatic potential", "Current electricity","Capacitor","Magnetism","EMI","Alternating Current"] },
                { name: "Optics and Modern Physics", topics: ["Ray Optics", "Wave Optics","Modern Physics","Electromagnetic Waves","Semiconductor"] }
            ],
            Chemistry: [
                { name: "Physical Chemistry", topics: ["Mole Concept", "Atomic Structure", "Gaseous State","Thermodynamics","Chemical Equilibrium","Ionic Equilibrium","Redox Reaction","Solutions","Electrochemistry","Chemical Kinetics","Surface Chemistry"] },
                { name: "Organic Chemistry", topics: ["Nomenclature","General Organic Chemistry (GOC)","Isomerism", "Hydrocarbons","Haloalkane & Haloarenes", "Alcohols, Phenols, Ethers","Aldehyde, Ketone, Carboxylic Acid","Amines","Biomolecules","Chemistry in everyday life","Polymer","Environmental Chemistry"] },
                { name: "Inorganic Chemistry", topics: ["Periodic Properties of Elements", "Chemical Bonding","Salt Analysis","Metallurgy", "D and F Block","P block","S block", "Hydrogen"] }
            ],
            Mathematics: [
                { name: "Algebra", topics: ["Basic Maths","Sets", "Complex Numbers", "Quadratic Equations","Sequence and Series","Permutations and Combinations","Binomial Theorem","Matrices","Determinants","Probability","Statistics"] },
                { name: "Trigonometry", topics: ["Trigonometric Functions","Trigonometric Equation","Inverse Trigonometry","Solution Of Triangles"] },
                { name: "Calculus", topics: ["Relation and Functions","MOD","Limits, Continuity & Differentiability", "AOD", "Indefinite Integration", "Definite Integration","Area Under Curves","Differential Equation"] },
                { name: "Co-Ordinate Geometry", topics: ["Straight Lines","Circles","Parabola","Ellipse","Hyperbola"] },
                { name: "Vector 3D", topics:["Vector","3 Dimentional Geometry"]}
            ]
        };

        // Calculate total topics once
        Object.values(JEE_SYLLABUS).forEach(groups => {
            groups.forEach(group => {
                totalTopicsCount += group.topics.length;
            });
        });
        
        // --- FIREBASE INITIALIZATION & AUTH (AUTO-SIGN-IN) ---

        window.onload = async () => {
            const authStatusElement = document.getElementById('auth-status');
            
            try {
                if (firebaseConfig) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // 1. Attempt Custom Token Sign-in (preferred), with anonymous fallback if token fails
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (tokenError) {
                            console.warn("Custom token failed:", tokenError.message, "Attempting anonymous sign-in as fallback.");
                            // Fallback to anonymous sign-in if custom token is mismatched or invalid
                            await signInAnonymously(auth);
                            authStatusElement.textContent = 'Warning: Custom token failed. Signed in anonymously for persistence.';
                        }
                    } else {
                        // If no token, use anonymous sign-in directly
                        await signInAnonymously(auth);
                    }

                    // 2. Wait for auth state to be established
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            
                            // Initialize local profile state if it wasn't already loaded from Firestore
                            if (userProfile.name === 'Anonymous User') {
                                userProfile.name = `User ${user.uid.substring(0, 4)}`;
                                userProfile.avatar = generateRandomAvatarEmoji();
                            }
                            
                            // Only update status if it's the default loading message or the warning message
                            if (authStatusElement.textContent.includes('Initializing') || authStatusElement.textContent.includes('Warning: Custom token failed')) {
                                authStatusElement.textContent = `Progress automatically saved. Your ID: ${userId.substring(0, 8)}...`;
                            }

                            document.getElementById('tracker-ui').classList.remove('hidden');
                            updateHeaderUI();
                            loadProgressData(); // Start listening for data
                        } else {
                            if (!authStatusElement.textContent.includes('Error:')) {
                                authStatusElement.textContent = 'Error: Could not establish an anonymous tracking session.';
                            }
                        }
                    });

                } else {
                    console.error("Firebase config missing. Cannot save data.");
                    authStatusElement.textContent = 'ERROR: Firebase configuration is missing. Data saving is disabled.';
                }

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // This catch handles general initialization errors outside of the sign-in logic
                authStatusElement.textContent = `Error during setup: ${error.message}`;
            }
        };

        function updateHeaderUI() {
            // Update the header text to show the current anonymous session ID
            const headerElement = document.getElementById('session-display');
            if (userId) {
                headerElement.innerHTML = `
                    <span id="profile-avatar" class="text-3xl mr-2">${userProfile.avatar}</span>
                    <div class="text-left">
                        <span class="text-xl font-bold text-gray-800">${userProfile.name}</span>
                        <p class="text-sm text-gray-500">Session ID: ${userId.substring(0, 8)}...</p>
                    </div>
                `;
            }
        }

        // --- UTILITY FUNCTIONS ---
        const generateRandomAvatarEmoji = () => {
            const randomIndex = Math.floor(Math.random() * AVATAR_EMOJIS.length);
            return AVATAR_EMOJIS[randomIndex];
        };

        // --- FIREBASE DATA FUNCTIONS ---

        const getProgressDocRef = () => {
            if (!db || !userId) return null;
            // Private data storage path: /artifacts/{appId}/users/{userId}/jee_4stage_tracker
            const userPath = `/artifacts/${appId}/users/${userId}/jee_4stage_tracker`; 
            return doc(db, userPath, "progress");
        };

        const initializeUserProfile = async (uid, name, avatar) => {
            const docRef = doc(db, `/artifacts/${appId}/users/${uid}/jee_4stage_tracker`, "progress");
            try {
                // Use merge: true to avoid deleting existing fields if they exist (though 'topics' is initialized empty here)
                await setDoc(docRef, { 
                    profile: { name, avatar, createdAt: new Date().toISOString() },
                    topics: {} // Initialize empty topics object
                }, { merge: true });
            } catch (error) {
                 console.error("Error initializing user profile:", error);
            }
        };

        const loadProgressData = () => {
            const progressDocRef = getProgressDocRef();
            if (!progressDocRef) return;

            onSnapshot(progressDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    if (data.profile) {
                         // Only update profile if data exists, but avoid overwriting a saved custom name if one was added later
                         if (data.profile.name && data.profile.name.startsWith('User')) {
                             userProfile.name = data.profile.name;
                             userProfile.avatar = data.profile.avatar;
                             updateHeaderUI();
                        }
                    }

                    userProgress = data.topics || {};

                } else {
                    console.log("No progress document found. Initializing profile with default values.");
                    initializeUserProfile(userId, userProfile.name, userProfile.avatar);
                }
                
                renderSyllabusUI();
                updateOverallProgress();

            }, (error) => {
                console.error("Error listening to progress data:", error);
            });
        };

        const updateProgressInFirestore = async (topicKey, stage) => {
            if (!db || !userId) {
                console.error("Cannot save data: User not authenticated.");
                showNotification('Save Error', 'Cannot save data. Session not established.', 'bg-red-500');
                return;
            }

            const docRef = getProgressDocRef();
            const previousStage = userProgress[topicKey] || 0;
            
            // Optimistically update local state
            userProgress[topicKey] = stage;

            if (stage === 4 && previousStage < 4) {
                showNotification('Topic Complete!', `Congrats! You finished the **${topicKey.split('-')[1]}** revision milestone.`, 'bg-green-600');
            }
            
            const totalRevised = Object.values(userProgress).filter(s => s === 4).length;
            if (totalRevised === totalTopicsCount) {
                showNotification('Syllabus Mastered!', 'ðŸ¥³ You completed all JEE topics! You are ready for the exam!', 'bg-indigo-600', 8000);
            }

            try {
                // Update the single field using updateDoc for efficiency
                await updateDoc(docRef, { [`topics.${topicKey}`]: stage });
            } catch (error) {
                console.error("Error updating document:", error);
                showNotification('Database Write Failed', 'There was an issue saving your progress. Check console for details.', 'bg-red-700');
            }
        };

        // --- UI RENDERING & LOGIC (Updated to reflect new CSS colors) ---

        function showNotification(title, message, bgColor, duration = 4000) {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = `notification-toast p-4 mb-3 rounded-lg shadow-xl text-white ${bgColor}`;
            toast.innerHTML = `
                <div class="font-bold text-lg mb-1">${title}</div>
                <div class="text-sm">${message}</div>
            `;
            
            container.appendChild(toast);

            setTimeout(() => {
                // Use setTimeout to ensure the fadeOut animation runs after the initial duration
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                    // Remove element after fadeOut transition completes (0.5s)
                    setTimeout(() => toast.remove(), 500); 
                }, duration - 500); 
            }, 0); // Start showing immediately
        }

        function updateOverallProgress() {
            let analysis = {
                overall: { totalTopics: totalTopicsCount, totalStages: totalTopicsCount * 4, completedStages: 0, percentage: 0, stages: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 } },
                subjects: { Physics: { totalTopics: 0, totalStages: 0, completedStages: 0, percentage: 0, stages: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 } }, Chemistry: { totalTopics: 0, totalStages: 0, completedStages: 0, percentage: 0, stages: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 } }, Mathematics: { totalTopics: 0, totalStages: 0, completedStages: 0, percentage: 0, stages: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 } } }
            };
            
            Object.entries(JEE_SYLLABUS).forEach(([subject, groups]) => {
                groups.forEach(group => {
                    group.topics.forEach(topic => {
                        const topicKey = `${subject}-${topic}`;
                        const stage = userProgress[topicKey] || 0;
                        
                        const sub = analysis.subjects[subject];
                        // Null check added for safety, though structure assumes subjects exist
                        if (sub) { 
                            sub.totalTopics++;
                            sub.totalStages += 4;
                            sub.completedStages += stage;
                            sub.stages[stage]++;

                            analysis.overall.completedStages += stage;
                            analysis.overall.stages[stage]++;
                        }
                    });
                });
            });

            const calculatePercentage = (completed, total) => total > 0 ? ((completed / total) * 100).toFixed(1) : 0;

            analysis.overall.percentage = calculatePercentage(analysis.overall.completedStages, analysis.overall.totalStages);
            Object.keys(analysis.subjects).forEach(subject => {
                const data = analysis.subjects[subject];
                data.percentage = calculatePercentage(data.completedStages, data.totalStages);
            });
            
            // 3. Update UI
            const topicsCompleted = analysis.overall.stages[4];
            const overallPercentage = analysis.overall.percentage;

            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const topicsCompletedDisplay = document.getElementById('topics-completed');
            const totalTopicsDisplay = document.getElementById('total-topics');


            if (progressBar) {
                progressBar.style.width = `${overallPercentage}%`;
                progressText.textContent = `Overall Progress: ${overallPercentage}% (${analysis.overall.completedStages}/${analysis.overall.totalStages} milestones)`;
                topicsCompletedDisplay.textContent = `${topicsCompleted}`;
                totalTopicsDisplay.textContent = `${totalTopicsCount}`;


                let colorClass = 'bg-red-500';
                if (overallPercentage > 25) colorClass = 'bg-orange-500';
                if (overallPercentage > 50) colorClass = 'bg-yellow-500';
                if (overallPercentage > 75) colorClass = 'bg-green-500';

                progressBar.className = `h-4 rounded-full transition-all duration-500 ease-out ${colorClass}`;
            }
            
            ['Physics', 'Chemistry', 'Mathematics'].forEach(subject => {
                const data = analysis.subjects[subject];
                if(document.getElementById(`${subject.toLowerCase()}-progress`)) {
                    document.getElementById(`${subject.toLowerCase()}-progress`).textContent = `${data.percentage}%`;
                    document.getElementById(`${subject.toLowerCase()}-total-topics`).textContent = `${data.totalTopics} Topics`;
                    document.getElementById(`${subject.toLowerCase()}-bar`).style.width = `${data.percentage}%`;
                }
            });
            
            renderStageAnalysis(analysis);
        }

        function renderStageAnalysis(analysis) {
            const stageAnalysisContainer = document.getElementById('stage-analysis-content');
            if (!stageAnalysisContainer) return;
            
            let stageHtml = '';
            const stageMapping = { 1: 'Lecture', 2: 'Practice', 3: 'PYQ', 4: 'Revision' };
            
            let overallBacklogHtml = '';
            for (let i = 1; i <= 4; i++) {
                const stageCount = analysis.overall.stages[i];
                if (stageCount > 0) {
                    const stageLabel = stageMapping[i];
                    let bgColor = 'bg-gray-200';
                    if (i === 1) bgColor = 'bg-yellow-100 text-yellow-800';
                    else if (i === 2) bgColor = 'bg-orange-100 text-orange-800';
                    else if (i === 3) bgColor = 'bg-purple-100 text-purple-800';
                    else if (i === 4) bgColor = 'bg-green-100 text-green-800';

                    overallBacklogHtml += `<span class="inline-flex items-center px-3 py-1 rounded-full text-base font-bold ${bgColor} mr-3 mb-2">
                                        ${stageCount} @ ${stageLabel}
                                    </span>`;
                }
            }

            Object.entries(analysis.subjects).forEach(([subject, data]) => {
                let backlogHtml = '';
                for (let i = 1; i <= 4; i++) {
                    const stageCount = data.stages[i];
                    if (stageCount > 0) {
                        const stageLabel = stageMapping[i];
                        let bgColor = 'bg-gray-200';
                        if (i === 1) bgColor = 'bg-yellow-100 text-yellow-800';
                        else if (i === 2) bgColor = 'bg-orange-100 text-orange-800';
                        else if (i === 3) bgColor = 'bg-purple-100 text-purple-800';
                        else if (i === 4) bgColor = 'bg-green-100 text-green-800';

                        backlogHtml += `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${bgColor} mr-2 mb-1">
                                            ${stageCount} @ ${stageLabel}
                                        </span>`;
                    }
                }
                
                stageHtml += `
                    <div class="p-4 bg-white rounded-xl shadow-lg border-t-4 border-sky-500">
                        <h4 class="text-xl font-bold text-sky-800 mb-3">${subject} (${data.totalTopics} Topics)</h4>
                        <p class="text-sm font-semibold text-gray-700 mb-2">Current Milestones:</p>
                        <div class="flex flex-wrap">
                            ${backlogHtml || '<span class="text-gray-400 text-sm">No topics started or all revised.</span>'}
                        </div>
                    </div>
                `;
            });

            stageAnalysisContainer.innerHTML = `
                <div class="md:col-span-3">
                    <h3 class="text-2xl font-extrabold text-indigo-700 mb-4 border-b pb-2">Overall Backlog Summary</h3>
                    <div class="flex flex-wrap p-4 bg-indigo-50 rounded-xl shadow-inner mb-6">
                        ${overallBacklogHtml || '<span class="text-gray-400 font-bold">No milestones started yet!</span>'}
                    </div>
                </div>
                ${stageHtml}
            `;
        }


        function handleStageChange(event) {
            const topicKey = event.target.name; 
            const stage = parseInt(event.target.value, 10);
            updateProgressInFirestore(topicKey, stage);
        };

        function renderSyllabusUI() {
            const container = document.getElementById('syllabus-content');
            container.innerHTML = ''; 

            Object.entries(JEE_SYLLABUS).forEach(([subject, groups]) => {
                const subjectCard = document.createElement('div');
                subjectCard.className = 'bg-white p-4 sm:p-6 rounded-xl shadow-2xl border-t-8 border-sky-600 transition duration-500 hover:shadow-sky-300/50';

                const subjectTitle = document.createElement('h2');
                subjectTitle.className = 'text-2xl sm:text-3xl font-extrabold text-sky-700 mb-4 border-b-2 pb-2';
                subjectTitle.textContent = subject;
                subjectCard.appendChild(subjectTitle);

                groups.forEach(group => {
                    const groupSection = document.createElement('div');
                    groupSection.className = 'mb-6 p-4 bg-gray-50 rounded-xl shadow-inner';

                    const groupTitle = document.createElement('h3');
                    groupTitle.className = 'text-lg font-bold text-sky-800 mb-3 border-b pb-1';
                    groupTitle.textContent = group.name;
                    groupSection.appendChild(groupTitle);

                    const topicsList = document.createElement('div');
                    topicsList.className = 'space-y-3';

                    group.topics.forEach(topic => {
                        const topicKey = `${subject}-${topic}`;
                        const currentStage = userProgress[topicKey] || 0;

                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 rounded-lg bg-white border border-gray-100 shadow-sm';

                        const label = document.createElement('span');
                        label.className = `text-base font-medium text-gray-800 w-full sm:w-1/2 mr-4 ${currentStage === 4 ? 'line-through text-gray-500' : ''}`;
                        label.textContent = topic;
                        itemDiv.appendChild(label);

                        // Stage Segmented Control
                        const stageControl = document.createElement('div');
                        stageControl.className = 'radio-stage flex flex-wrap justify-start sm:justify-end space-x-1 p-1 bg-gray-100 rounded-md mt-2 sm:mt-0 shadow-inner';

                        // Add "Reset to None" (Stage 0) first
                        const resetRadioId = `${topicKey}-0`;
                        const isResetChecked = currentStage === 0;
                        const resetInput = document.createElement('input');
                        resetInput.type = 'radio';
                        resetInput.id = resetRadioId;
                        resetInput.name = topicKey;
                        resetInput.value = 0;
                        resetInput.checked = isResetChecked;
                        resetInput.className = `stage-0`;
                        resetInput.addEventListener('change', handleStageChange);
                        const resetLabel = document.createElement('label');
                        resetLabel.htmlFor = resetRadioId;
                        resetLabel.textContent = 'Reset';
                        stageControl.appendChild(resetInput);
                        stageControl.appendChild(resetLabel);

                        PROGRESS_STAGES.filter(s => s.id > 0).forEach(stage => {
                            const radioId = `${topicKey}-${stage.id}`;
                            const isChecked = currentStage === stage.id;

                            const input = document.createElement('input');
                            input.type = 'radio';
                            input.id = radioId;
                            input.name = topicKey; 
                            input.value = stage.id;
                            input.checked = isChecked;
                            input.className = `stage-${stage.id}`; // This links to the new CSS classes
                            input.addEventListener('change', handleStageChange);

                            const labelEl = document.createElement('label');
                            labelEl.htmlFor = radioId;
                            labelEl.textContent = stage.label;
                            
                            stageControl.appendChild(input);
                            stageControl.appendChild(labelEl);
                        });


                        itemDiv.appendChild(stageControl);
                        topicsList.appendChild(itemDiv);
                    });

                    groupSection.appendChild(topicsList);
                    subjectCard.appendChild(groupSection);
                });
                container.appendChild(subjectCard);
            });
        };

    </script>
</head>
<body class="min-h-screen">
    <div id="notification-container">
        <!-- Toast notifications appear here -->
    </div>
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-8 sm:mb-10 bg-white p-4 sm:p-6 rounded-xl shadow-lg border-b-4 border-indigo-600 flex justify-between items-center">
            <div>
                <h1 class="text-3xl sm:text-4xl font-black text-indigo-700 mb-1">JEE 4-Stage Tracker</h1>
                <p class="text-base sm:text-lg text-gray-600">Track milestones: **Lecture, Practice, PYQ, Revision**.</p>
            </div>
            <div id="session-display" class="flex items-center p-2 bg-indigo-50 rounded-lg shadow-inner">
                <span class="text-3xl mr-2">...</span>
                <div class="text-left">
                    <span class="text-xl font-bold text-gray-800">Loading Session...</span>
                    <p class="text-sm text-gray-500">Connecting to database...</p>
                </div>
            </div>
        </header>

        <!-- Status Bar -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 p-3 bg-indigo-50 rounded-lg shadow-inner text-sm text-indigo-700">
            <!-- Status message updates from JS to indicate readiness -->
            <span id="auth-status" class="font-medium">Initializing connection for automatic saving...</span>
        </div>

        <!-- MAIN TRACKER UI (Visible immediately, but data loads only after session established) -->
        <div id="tracker-ui" class="hidden">
            
            <!-- Overall Progress Card -->
            <div id="progress-container" class="bg-white p-6 rounded-xl shadow-xl mb-10 border-l-4 border-indigo-500">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="flex flex-col p-3 bg-blue-50 rounded-lg">
                        <span class="text-lg font-bold text-gray-800">Total Topics:</span>
                        <span id="total-topics" class="text-3xl font-extrabold text-blue-600">--</span>
                    </div>
                    <div class="flex flex-col p-3 bg-green-50 rounded-lg">
                        <span class="text-lg font-bold text-gray-800">Topics Revised (4/4):</span>
                        <span id="topics-completed" class="text-3xl font-extrabold text-green-600">--</span>
                    </div>
                    <div class="flex flex-col p-3 bg-indigo-50 rounded-lg">
                        <span class="text-lg font-bold text-gray-800">Overall Milestone Progress:</span>
                        <span id="progress-text" class="text-xl font-extrabold text-indigo-600 mt-1">Loading progress...</span>
                    </div>
                </div>
                
                <!-- Overall Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-4 mb-6">
                    <div id="progress-bar" class="h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>

                <!-- Subject-wise Percentage Breakdown -->
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-1">Subject Breakdown</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <!-- Physics -->
                    <div class="p-3 bg-sky-50 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-sky-700">Physics</span>
                            <span id="physics-progress" class="text-xl font-extrabold text-sky-600">--%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="physics-bar" class="h-2 rounded-full bg-sky-500" style="width: 0%"></div>
                        </div>
                        <span id="physics-total-topics" class="text-xs text-gray-500 mt-1 block">-- Topics</span>
                    </div>

                    <!-- Chemistry -->
                    <div class="p-3 bg-fuchsia-50 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-fuchsia-700">Chemistry</span>
                            <span id="chemistry-progress" class="text-xl font-extrabold text-fuchsia-600">--%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="chemistry-bar" class="h-2 rounded-full bg-fuchsia-500" style="width: 0%"></div>
                        </div>
                        <span id="chemistry-total-topics" class="text-xs text-gray-500 mt-1 block">-- Topics</span>
                    </div>

                    <!-- Mathematics -->
                    <div class="p-3 bg-amber-50 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-amber-700">Mathematics</span>
                            <span id="mathematics-progress" class="text-xl font-extrabold text-amber-600">--%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="mathematics-bar" class="h-2 rounded-full bg-amber-500" style="width: 0%"></div>
                        </div>
                        <span id="mathematics-total-topics" class="text-xs text-gray-500 mt-1 block">-- Topics</span>
                    </div>
                </div>
            </div>

            <!-- Stage Analysis Card -->
            <div id="analysis-container" class="bg-white p-6 rounded-xl shadow-xl mb-10 border-l-4 border-purple-500">
                <h2 class="text-2xl font-black text-purple-700 mb-4">Topic Stage Analysis</h2>
                <p class="text-gray-600 mb-6">This breakdown shows the number of topics currently stuck at a specific milestone.</p>
                
                <div id="stage-analysis-content" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="md:col-span-3 text-center p-8 text-gray-400">Loading analysis...</div>
                </div>
            </div>


            <!-- Syllabus Content -->
            <div id="syllabus-content" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Syllabus content generated by renderSyllabusUI function -->
            </div>

        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center text-sm text-gray-500 border-t pt-4">
            <p>Stages: 1=Lecture, 2=Practice, 3=PYQ, 4=Revision. Progress is saved automatically using your unique session ID.</p>
        </footer>
    </div>
</body>
</html>
