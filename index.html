<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE Progress Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }

        /* Specific colors for stages (used for background and text based on completion) */
        .stage-lecture-color { @apply bg-yellow-500; }
        .stage-practice-color { @apply bg-orange-500; }
        .stage-pyq-color { @apply bg-purple-500; }
        .stage-revision-color { @apply bg-green-500; }

        /* Notification Toast Container */
        #notification-container {
            position: fixed; top: 20px; right: 20px; z-index: 60;
            max-width: 90%; width: 350px;
        }
        .notification-toast {
            animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-in forwards 4s;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }

    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // --- HARDCODED FIREBASE CONFIGURATION ---
        const HARDCODED_FIREBASE_CONFIG = { 
 ¬† ¬† ¬† ¬† ¬† ¬† apiKey: "AIzaSyB9wE0qIEvaueXJzLyIQQmvhyGJC6k-j94", 
 ¬† ¬† ¬† ¬† ¬† ¬† authDomain: "jee-tracker-ead00.firebaseapp.com", 
 ¬† ¬† ¬† ¬† ¬† ¬† projectId: "jee-tracker-ead00", 
 ¬† ¬† ¬† ¬† ¬† ¬† storageBucket: "jee-tracker-ead00.firebasestorage.app", 
 ¬† ¬† ¬† ¬† ¬† ¬† messagingSenderId: "818054839055", 
 ¬† ¬† ¬† ¬† ¬† ¬† appId: "1:818054839055:web:139434c214d335247e5c7a" 
        };

        // --- GLOBAL FIREBASE/APP VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : HARDCODED_FIREBASE_CONFIG.projectId; 
        const firebaseConfig = HARDCODED_FIREBASE_CONFIG;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        let app, db, auth, userId = null;
        // userProgress now stores an object for each topic, not a single number
        let userProgress = {}; 
        let totalTopicsCount = 0;
        let userProfile = { name: 'Anonymous User', avatar: 'üöÄ' }; 
        // Filter now uses the stage key (e.g., 'lecture', 'pyq')
        let currentFilterKey = null; 

        const AVATAR_EMOJIS = ['üê∂', 'üê±', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêÖ', 'üêò', 'üêí', 'ü¶ñ', 'ü¶ã', 'ü¶â', 'üê¢', 'üçé', 'üçì', 'üçç', 'üçâ', 'ü•ù', 'ü•≠', 'üçá'];
        
        // Structure defining the 4 independent stages (icon property removed)
        const STAGE_KEYS = [
            { key: 'lecture', label: 'Lecture', colorClass: 'stage-lecture-color' },
            { key: 'practice', label: 'Practice', colorClass: 'stage-practice-color' },
            { key: 'pyq', label: 'PYQ', colorClass: 'stage-pyq-color' },
            { key: 'revision', label: 'Revision', colorClass: 'stage-revision-color' }
        ];

        // --- CORE SYLLABUS STRUCTURE (unchanged) ---
        const JEE_SYLLABUS = {
 ¬† ¬† ¬† ¬† ¬† ¬†Physics: [
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Mechanics", topics: ["Units, Dimensions & Errors","Errors and measurements", "Motion in 1D","Motion in 2D", "Newton's Laws of Motion (NLM)","Work Power Energy","Centre of mass", "Rotational Motion","Mechanical Properties of Solid","Mechanical Properties of Fluid"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Thermodynamics", topics: ["Thermal Properties", "Thermodynamics & KTG"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Waves", topics: ["SHM", "Waves",] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Electro-Magnetism", topics: ["Electrostatics and electrostatic potential", "Current electricity","Capacitor","Magnetism","EMI","Alternating Current"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Optics and Modern Physics", topics: ["Ray Optics", "Wave Optics","Modern Physics","Electromagnetic Waves","Semiconductor"] }
 ¬† ¬† ¬† ¬† ¬† ¬†],
 ¬† ¬† ¬† ¬† ¬† ¬†Chemistry: [
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Physical Chemistry", topics: ["Mole Concept", "Atomic Structure", "Gaseous State","Thermodynamics","Chemical Equilibrium","Ionic Equilibrium","Redox Reaction","Solutions","Electrochemistry","Chemical Kinetics","Surface Chemistry"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Organic Chemistry", topics: ["Nomenclature","General Organic Chemistry (GOC)","Isomerism", "Hydrocarbons","Haloalkane & Haloarenes", "Alcohols, Phenols, Ethers","Aldehyde, Ketone, Carboxylic Acid","Amines","Biomolecules","Chemistry in everyday life","Polymer","Environmental Chemistry"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Inorganic Chemistry", topics: ["Periodic Properties of Elements", "Chemical Bonding","Salt Analysis","Metallurgy", "D and F Block","P block","S block", "Hydrogen"] }
 ¬† ¬† ¬† ¬† ¬† ¬†],
 ¬† ¬† ¬† ¬† ¬† ¬†Mathematics: [
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Algebra", topics: ["Basic Maths","Sets", "Complex Numbers", "Quadratic Equations","Sequence and Series","Permutations and Combinations","Binomial Theorem","Matrices","Determinants","Probability","Statistics"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Trigonometry", topics: ["Trigonometric Functions","Trigonometric Equation","Inverse Trigonometry","Solution Of Triangles"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Calculus", topics: ["Relation and Functions","MOD","Limits, Continuity & Differentiability", "AOD", "Indefinite Integration", "Definite Integration","Area Under Curves","Differential Equation"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Co-Ordinate Geometry", topics: ["Straight Lines","Circles","Parabola","Ellipse","Hyperbola"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Vector 3D", topics:["Vector","3 Dimentional Geometry"]}
 ¬† ¬† ¬† ¬† ¬† ¬†]
 ¬† ¬† ¬† ¬†};

        // Calculate total topics once
        Object.values(JEE_SYLLABUS).forEach(groups => {
            groups.forEach(group => {
                totalTopicsCount += group.topics.length;
            });
        });
        
        // --- FIREBASE INITIALIZATION & AUTH (AUTO-SIGN-IN) ---

        function setupUnauthenticatedSession(errorMessage) {
            userId = 'UNAUTHENTICATED';
            
            const authStatusElement = document.getElementById('auth-status');
            authStatusElement.innerHTML = `<span class="font-bold text-red-700">FATAL AUTH ERROR (Saving Disabled):</span> ${errorMessage}. <br> Enable **Anonymous Authentication** in Firebase to save progress automatically.`;

            const headerElement = document.getElementById('session-display');
            headerElement.innerHTML = `
                <span class="text-3xl mr-2">‚ùå</span>
                <div class="text-left">
                    <span class="text-xl font-bold text-red-600">UNSAVED SESSION</span>
                    <p class="text-sm text-red-400">Progress will not be saved.</p>
                </div>
            `;
            
            document.getElementById('tracker-ui').classList.remove('hidden');
            renderSyllabusUI();
            updateOverallProgress(); 
        }
        
        async function setupAuthenticatedSession(user) {
            userId = user.uid;
            
            if (userProfile.name === 'Anonymous User') {
                userProfile.name = `User ${user.uid.substring(0, 4)}`;
                userProfile.avatar = generateRandomAvatarEmoji();
            }
            
            const authStatusElement = document.getElementById('auth-status');
            if (authStatusElement.textContent.includes('Initializing') || authStatusElement.textContent.includes('Warning: Custom token failed')) {
                authStatusElement.textContent = `Progress automatically saved. Your ID: ${userId.substring(0, 8)}...`;
            }

            document.getElementById('tracker-ui').classList.remove('hidden');
            updateHeaderUI();
            loadProgressData(); 
        }


        window.onload = async () => {
            const authStatusElement = document.getElementById('auth-status');
            
            try {
                if (!firebaseConfig) {
                    throw new Error("Firebase configuration is missing.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                let signedInUser = null;

                try {
                    if (initialAuthToken) {
                        try {
                            const result = await signInWithCustomToken(auth, initialAuthToken);
                            signedInUser = result.user;
                        } catch (tokenError) {
                            console.warn("Custom token failed. Attempting anonymous sign-in as fallback.");
                            const result = await signInAnonymously(auth); 
                            signedInUser = result.user;
                            authStatusElement.textContent = 'Warning: Custom token failed. Signed in anonymously for persistence.';
                        }
                    } else {
                        const result = await signInAnonymously(auth);
                        signedInUser = result.user;
                    }
                    
                    if (signedInUser) {
                        await setupAuthenticatedSession(signedInUser);
                    } else {
                        throw new Error("Authentication process finished without a user.");
                    }

                } catch (authError) {
                    console.error("Authentication Error (Saving Disabled):", authError);
                    setupUnauthenticatedSession(authError.message);
                }

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                authStatusElement.textContent = `CRITICAL ERROR: ${error.message}`;
                setupUnauthenticatedSession(error.message);
            }
        };


        function updateHeaderUI() {
            const headerElement = document.getElementById('session-display');
            if (userId) {
                headerElement.innerHTML = `
                    <span id="profile-avatar" class="text-3xl mr-2">${userProfile.avatar}</span>
                    <div class="text-left">
                        <span class="text-xl font-bold text-gray-800">${userProfile.name}</span>
                        <p class="text-sm text-gray-500">Session ID: ${userId.substring(0, 8)}...</p>
                    </div>
                `;
            }
        }

        // --- UTILITY FUNCTIONS ---
        const generateRandomAvatarEmoji = () => {
            const randomIndex = Math.floor(Math.random() * AVATAR_EMOJIS.length);
            return AVATAR_EMOJIS[randomIndex];
        };

        const calculatePercentage = (count, total) => total > 0 ? ((count / total) * 100).toFixed(1) : 0;


        // --- FIREBASE DATA FUNCTIONS ---

        const getProgressDocRef = () => {
            if (!db || !userId || userId === 'UNAUTHENTICATED') return null;
            const userPath = `/artifacts/${appId}/users/${userId}/jee_4stage_independent_tracker`; 
            return doc(db, userPath, "progress");
        };

        const initializeUserProfile = async (uid, name, avatar) => {
            const docRef = doc(db, `/artifacts/${appId}/users/${uid}/jee_4stage_independent_tracker`, "progress");
            try {
                await setDoc(docRef, { 
                    profile: { name, avatar, createdAt: new Date().toISOString() },
                    topics: {} 
                }, { merge: true });
            } catch (error) {
                 console.error("Error initializing user profile:", error);
            }
        };

        const loadProgressData = () => {
            const progressDocRef = getProgressDocRef();
            if (!progressDocRef) {
                renderSyllabusUI();
                updateOverallProgress();
                return;
            }

            onSnapshot(progressDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    if (data.profile) {
                         if (data.profile.name && data.profile.name.startsWith('User')) {
                             userProfile.name = data.profile.name;
                             userProfile.avatar = data.profile.avatar;
                             updateHeaderUI();
                        }
                    }
                    // Load the new object-based progress structure
                    userProgress = data.topics || {};

                } else {
                    console.log("No progress document found. Initializing profile with default values.");
                    initializeUserProfile(userId, userProfile.name, userProfile.avatar);
                }
                
                renderFilterStatus(); // Update filter display
                renderSyllabusUI();
                updateOverallProgress();

            }, (error) => {
                console.error("Error listening to progress data:", error);
            });
        };

        window.toggleStageCompletion = function(topicKey, stageKey) {
            // Get current status, or default to false
            const isCompleted = userProgress[topicKey]?.[stageKey] || false;
            const newStatus = !isCompleted;
            
            // Optimistically update local state
            userProgress[topicKey] = { ...(userProgress[topicKey] || {}), [stageKey]: newStatus };
            
            // Re-render UI immediately for responsiveness
            renderSyllabusUI();
            updateOverallProgress(); 
            
            // Save to Firestore
            updateProgressInFirestore(topicKey, stageKey, newStatus);
        }

        const updateProgressInFirestore = async (topicKey, stageKey, newStatus) => {
            if (!db || !userId || userId === 'UNAUTHENTICATED') {
                console.error("Cannot save data: User not authenticated.");
                showNotification('Save Error', 'Cannot save data. Session not established.', 'bg-red-500');
                return;
            }

            const docRef = getProgressDocRef();
            
            try {
                // Use the new path structure: topics["topic-key"][stageKey] = newStatus
                await updateDoc(docRef, { [`topics.${topicKey}.${stageKey}`]: newStatus });
                
                if (stageKey === 'revision' && newStatus) {
                    showNotification('Milestone Achieved!', `Revision for **${topicKey.split('-')[1]}** is complete!`, 'bg-green-600');
                }
            } catch (error) {
                console.error("Error updating document:", error);
                showNotification('Database Write Failed', 'There was an issue saving your progress. Check console for details.', 'bg-red-700');
            }
        };

        // --- FILTER LOGIC ---
        window.setFilter = function(stageKey) {
            if (currentFilterKey === stageKey) {
                // Toggle off if already active
                currentFilterKey = null;
            } else {
                currentFilterKey = stageKey;
            }
            renderFilterStatus(); 
            renderSyllabusUI(); 
            updateOverallProgress(); 
        }

        function renderFilterStatus() {
            const filterStatus = document.getElementById('filter-status');
            if (currentFilterKey === null) {
                filterStatus.classList.add('hidden');
                filterStatus.innerHTML = '';
            } else {
                const stage = STAGE_KEYS.find(s => s.key === currentFilterKey);
                filterStatus.classList.remove('hidden');
                filterStatus.innerHTML = `
                    <div class="flex items-center justify-between w-full p-4 bg-yellow-100 rounded-xl shadow border border-yellow-300">
                        <span class="font-bold text-lg text-yellow-800">Filter Active:</span> 
                        <span class="text-md text-yellow-700">Showing only topics where **${stage.label}** is completed.</span>
                        <button onclick="setFilter(null)" class="ml-4 px-3 py-1 bg-red-500 text-white text-sm font-semibold rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
                            Reset Filter ‚ùå
                        </button>
                    </div>
                `;
            }
        }


        // --- UI RENDERING & LOGIC ---

        function showNotification(title, message, bgColor, duration = 4000) {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = `notification-toast p-4 mb-3 rounded-lg shadow-xl text-white ${bgColor}`;
            toast.innerHTML = `
                <div class="font-bold text-lg mb-1">${title}</div>
                <div class="text-sm">${message}</div>
            `;
            
            container.appendChild(toast);

            setTimeout(() => {
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                    setTimeout(() => toast.remove(), 500); 
                }, duration - 500); 
            }, 0); 
        }

        function updateOverallProgress() {
            let analysis = {
                totalTopics: totalTopicsCount,
                completedRevisionTopics: 0,
                
                // Track completion count for each independent stage
                progressByStage: STAGE_KEYS.reduce((acc, stage) => {
                    acc[stage.key] = { label: stage.label, count: 0, percentage: 0, colorClass: stage.colorClass };
                    return acc;
                }, {}),

                // For subject breakdown, we track total completed *stages* (4 stages per topic)
                subjects: { Physics: { totalTopics: 0, completedStages: 0, percentage: 0 }, Chemistry: { totalTopics: 0, completedStages: 0, percentage: 0 }, Mathematics: { totalTopics: 0, completedStages: 0, percentage: 0 } }
            };
            
            Object.entries(JEE_SYLLABUS).forEach(([subject, groups]) => {
                groups.forEach(group => {
                    group.topics.forEach(topic => {
                        const topicKey = `${subject}-${topic}`;
                        // Get progress object for the topic
                        const progress = userProgress[topicKey] || {};
                        
                        let completedStagesForTopic = 0;

                        STAGE_KEYS.forEach(stage => {
                            if (progress[stage.key]) {
                                analysis.progressByStage[stage.key].count++;
                                completedStagesForTopic++;
                            }
                        });

                        analysis.subjects[subject].totalTopics++;
                        analysis.subjects[subject].completedStages += completedStagesForTopic;

                        if (progress.revision) {
                            analysis.completedRevisionTopics++;
                        }
                    });
                });
            });

            // Calculate percentages for the 4 independent bars
            STAGE_KEYS.forEach(stage => {
                analysis.progressByStage[stage.key].percentage = calculatePercentage(analysis.progressByStage[stage.key].count, totalTopicsCount);
            });


            // 3. Update UI (Header Stats)
            const topicsRevisedDisplay = document.getElementById('topics-revised');
            const totalTopicsDisplay = document.getElementById('total-topics');
            
            if (topicsRevisedDisplay) {
                topicsRevisedDisplay.textContent = `${analysis.completedRevisionTopics}`;
                totalTopicsDisplay.textContent = `${totalTopicsCount}`;
            }

            // Render the 4 independent progress bars with click handlers and active state
            const progressContainer = document.getElementById('independent-progress-bars');
            if (progressContainer) {
                let barsHtml = '';
                STAGE_KEYS.forEach(stageData => {
                    
                    // --- FIX: Access the calculated metrics from the analysis object ---
                    const metrics = analysis.progressByStage[stageData.key]; 
                    
                    let hexColor;
                    if (stageData.key === 'lecture') hexColor = '#f59e0b'; // Tailwind yellow-600
                    else if (stageData.key === 'practice') hexColor = '#f97316'; // Tailwind orange-600
                    else if (stageData.key === 'pyq') hexColor = '#9333ea'; // Tailwind purple-600
                    else if (stageData.key === 'revision') hexColor = '#10b981'; // Tailwind green-600
                    else hexColor = '#6b7280'; // gray-500 fallback

                    const activeClass = currentFilterKey === stageData.key 
                        ? 'ring-4 ring-indigo-400/50 scale-[1.01] shadow-2xl ring-offset-2' 
                        : 'hover:shadow-xl hover:scale-[1.01] transition-all duration-200 cursor-pointer';
                    
                    // Indicator uses the dynamically calculated hex color
                    const indicator = `<span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${hexColor}"></span>`;

                    barsHtml += `
                        <div onclick="setFilter('${stageData.key}')" class="p-4 rounded-xl shadow-lg border-t-4 bg-white ${activeClass}" style="border-top-color: ${hexColor}">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                    ${indicator} ${stageData.label} Completed
                                </h3>
                                <!-- FIX APPLIED HERE: Use metrics.percentage and metrics.count -->
                                <span class="text-2xl font-extrabold text-indigo-600">${metrics.percentage}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="h-3 rounded-full transition-all duration-500 ease-out ${stageData.colorClass.replace('stage-', 'bg-')}" 
                                     style="width: ${metrics.percentage}%">
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">${metrics.count} / ${totalTopicsCount} Topics Completed.</p>
                            <p class="text-xs text-gray-400 mt-1">Click to filter topics where **${stageData.label}** is done.</p>
                        </div>
                    `;
                });
                progressContainer.innerHTML = barsHtml;
            }

            // Update Subject Breakdown
            Object.keys(analysis.subjects).forEach(subject => {
                const data = analysis.subjects[subject];
                // Max milestones for a subject (Total Topics * 4 independent stages)
                const totalSubMilestones = data.totalTopics * STAGE_KEYS.length; 
                data.percentage = calculatePercentage(data.completedStages, totalSubMilestones);
                
                if(document.getElementById(`${subject.toLowerCase()}-progress`)) {
                    document.getElementById(`${subject.toLowerCase()}-progress`).textContent = `${data.percentage}%`;
                    document.getElementById(`${subject.toLowerCase()}-total-topics`).textContent = `${data.totalTopics} Topics`;
                    document.getElementById(`${subject.toLowerCase()}-bar`).style.width = `${data.percentage}%`;
                }
            });
            
            renderStageAnalysis(analysis);
        }

        function renderStageAnalysis(analysis) {
             const stageAnalysisContainer = document.getElementById('stage-analysis-content');
             if (!stageAnalysisContainer) return;
             
             let overallHtml = STAGE_KEYS.map(stage => {
                const count = analysis.progressByStage[stage.key].count;
                const percentage = analysis.progressByStage[stage.key].percentage;
                return `
                    <div class="flex flex-col p-4 ${stage.colorClass.replace('stage-', 'bg-').replace('500', '100')} rounded-lg shadow-inner">
                        <span class="text-2xl font-extrabold ${stage.colorClass.replace('stage-', 'text-')}" >${percentage}%</span>
                        <span class="text-sm font-semibold text-gray-800">${count} Topics done with ${stage.label}</span>
                    </div>
                `;
             }).join('');


            let subjectHtml = Object.entries(analysis.subjects).map(([subject, data]) => {
                const totalStages = data.totalTopics * STAGE_KEYS.length;
                const remainingStages = totalStages - data.completedStages;
                
                return `
                    <div class="p-4 bg-white rounded-xl shadow-lg border-t-4 border-sky-500">
                        <h4 class="text-xl font-bold text-sky-800 mb-3">${subject} (${data.totalTopics} Topics)</h4>
                        <div class="text-2xl font-extrabold text-green-600">${data.completedStages}</div>
                        <p class="text-sm font-medium text-gray-700">Stages Completed / ${totalStages}</p>
                        <div class="text-xl font-extrabold text-red-600 mt-2">${remainingStages}</div>
                        <p class="text-sm font-medium text-gray-700">Stages Remaining</p>
                    </div>
                `;
            }).join('');

            stageAnalysisContainer.innerHTML = `
                <div class="md:col-span-3">
                    <h3 class="text-2xl font-extrabold text-indigo-700 mb-4 border-b pb-2">Overall Completion Status</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-indigo-50 rounded-xl shadow-inner mb-6">
                        ${overallHtml}
                    </div>
                </div>
                ${subjectHtml}
            `;
        }


        function renderSyllabusUI() {
            const container = document.getElementById('syllabus-content');
            container.innerHTML = ''; 

            let anyTopicVisible = false;
            
            Object.entries(JEE_SYLLABUS).forEach(([subject, groups]) => {
                const subjectCard = document.createElement('div');
                subjectCard.className = 'bg-white p-4 sm:p-6 rounded-xl shadow-2xl border-t-8 border-sky-600 transition duration-500 hover:shadow-sky-300/50';

                const subjectTitle = document.createElement('h2');
                subjectTitle.className = 'text-2xl sm:text-3xl font-extrabold text-sky-700 mb-4 border-b-2 pb-2';
                subjectTitle.textContent = subject;
                subjectCard.appendChild(subjectTitle);

                let subjectHasVisibleTopics = false;

                groups.forEach(group => {
                    const groupSection = document.createElement('div');
                    groupSection.className = 'mb-6 p-4 bg-gray-50 rounded-xl shadow-inner';

                    const groupTitle = document.createElement('h3');
                    groupTitle.className = 'text-lg font-bold text-sky-800 mb-3 border-b pb-1';
                    groupTitle.textContent = group.name;
                    groupSection.appendChild(groupTitle);
                    
                    let groupHasVisibleTopics = false;
                    const topicsList = document.createElement('div');
                    topicsList.className = 'space-y-3';


                    group.topics.forEach(topic => {
                        const topicKey = `${subject}-${topic}`;
                        const progress = userProgress[topicKey] || {};
                        
                        // Filter Logic: Only show topic if no filter is active OR if the specific stage is completed (true)
                        const isVisible = currentFilterKey === null || progress[currentFilterKey] === true;

                        if (isVisible) {
                            groupHasVisibleTopics = true;
                            subjectHasVisibleTopics = true;
                            anyTopicVisible = true;
                            
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 rounded-lg bg-white border border-gray-100 shadow-sm';

                            const label = document.createElement('span');
                            // If all 4 stages are complete, strike through the topic
                            const isFullyComplete = STAGE_KEYS.every(s => progress[s.key]);
                            label.className = `text-base font-medium text-gray-800 w-full sm:w-1/2 mr-4 ${isFullyComplete ? 'line-through text-gray-500' : ''}`;
                            label.textContent = topic;
                            itemDiv.appendChild(label);

                            // Independent Stage Toggles - Now using styled checkboxes
                            const stageToggles = document.createElement('div');
                            stageToggles.className = 'flex flex-wrap justify-start sm:justify-end space-x-2 p-1 bg-gray-100 rounded-md mt-2 sm:mt-0 shadow-inner';

                            STAGE_KEYS.forEach(stage => {
                                const isChecked = progress[stage.key] || false;
                                
                                // Wrapper for the checkbox and label
                                const stageWrapper = document.createElement('div');
                                stageWrapper.className = 'relative';

                                // 1. Hidden Checkbox Input
                                const checkboxId = `${topicKey}-${stage.key}-check`;
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.id = checkboxId;
                                checkbox.checked = isChecked;
                                checkbox.className = 'sr-only peer'; // Visually hide the native checkbox
                                // Use click handler to toggle completion
                                checkbox.onclick = () => toggleStageCompletion(topicKey, stage.key);
                                
                                // 2. Styled Label (the visible button/pill)
                                const label = document.createElement('label');
                                label.htmlFor = checkboxId;
                                
                                // Base classes for the pill/badge
                                const baseClasses = 'px-3 py-1 text-xs font-medium rounded-full cursor-pointer transition-all duration-200 flex items-center shadow-sm whitespace-nowrap';
                                
                                // MODIFIED: Changed peer-checked:text-white to peer-checked:text-gray-500 and added peer-checked:line-through
                                const checkedClasses = `peer-checked:text-gray-500 peer-checked:line-through peer-checked:${stage.colorClass.replace('stage-', 'bg-')} peer-checked:shadow-md`;
                                const uncheckedClasses = `peer-not-checked:bg-white peer-not-checked:text-gray-600 peer-not-checked:border peer-not-checked:border-gray-300 hover:bg-gray-100`;

                                label.className = `${baseClasses} ${checkedClasses} ${uncheckedClasses}`;

                                // Add content (Checkbox symbol and Label text)
                                // We need to check the local state here since this is part of the re-render logic
                                const currentIsChecked = userProgress[topicKey]?.[stage.key] || false;
                                label.innerHTML = `
                                    <span class="text-sm mr-1">${currentIsChecked ? '‚úîÔ∏è' : '‚òê'}</span> 
                                    <span>${stage.label}</span>
                                `;

                                stageWrapper.appendChild(checkbox);
                                stageWrapper.appendChild(label);
                                stageToggles.appendChild(stageWrapper);
                            });

                            itemDiv.appendChild(stageToggles);
                            topicsList.appendChild(itemDiv);
                        }
                    });

                    if (groupHasVisibleTopics) {
                        groupSection.appendChild(topicsList);
                        subjectCard.appendChild(groupSection);
                    }
                });
                
                if (subjectHasVisibleTopics) {
                    container.appendChild(subjectCard);
                }
            });
            
            // Handle case where filter is active but no topics match
            if (!anyTopicVisible && currentFilterKey !== null) {
                container.innerHTML = `<div class="md:col-span-3 text-center p-12 bg-yellow-50 rounded-xl shadow-inner border-y-4 border-yellow-300">
                    <h3 class="text-2xl font-bold text-yellow-800 mb-2">No Topics Found</h3>
                    <p class="text-lg text-yellow-700">There are no topics currently marked as **${STAGE_KEYS.find(s => s.key === currentFilterKey).label}** complete.</p>
                </div>`;
            } else if (!anyTopicVisible && currentFilterKey === null) {
                 container.innerHTML = `<div class="md:col-span-3 text-center p-12 bg-yellow-50 rounded-xl shadow-inner border-y-4 border-yellow-300">
                    <h3 class="text-2xl font-bold text-yellow-800 mb-2">Syllabus Missing</h3>
                    <p class="text-lg text-yellow-700">The syllabus definition is empty. Please check the 'JEE_SYLLABUS' object in the code.</p>
                </div>`;
            }
        };

    </script>
</head>
<body class="min-h-screen">
    <div id="notification-container">
        <!-- Toast notifications appear here -->
    </div>
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-8 sm:mb-10 bg-white p-4 sm:p-6 rounded-xl shadow-lg border-b-4 border-indigo-600 flex justify-between items-center">
            <div>
                <h1 class="text-3xl sm:text-4xl font-black text-indigo-700 mb-1">JEE Independent Stage Tracker</h1>
                <p class="text-base sm:text-lg text-gray-600">Mark Lecture, Practice, PYQ, and Revision independently for each topic.</p>
            </div>
            <div id="session-display" class="flex items-center p-2 bg-indigo-50 rounded-lg shadow-inner">
                <span class="text-3xl mr-2">...</span>
                <div class="text-left">
                    <span class="text-xl font-bold text-gray-800">Loading Session...</span>
                    <p class="text-sm text-gray-500">Connecting to database...</p>
                </div>
            </div>
        </header>

        <!-- Status Bar -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 p-3 bg-indigo-50 rounded-lg shadow-inner text-sm text-indigo-700">
            <span id="auth-status" class="font-medium">Initializing connection for automatic saving...</span>
        </div>

        <!-- MAIN TRACKER UI (Visible immediately, but data loads only after session established) -->
        <div id="tracker-ui" class="hidden">
            
            <!-- Overall Progress Card -->
            <div id="progress-container" class="bg-white p-6 rounded-xl shadow-xl mb-10 border-l-4 border-indigo-500">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="flex flex-col p-3 bg-blue-50 rounded-xl">
                        <span class="text-lg font-bold text-gray-800">Total Topics in Syllabus:</span>
                        <span id="total-topics" class="text-4xl font-extrabold text-blue-600">--</span>
                    </div>
                    <div class="flex flex-col p-3 bg-green-50 rounded-xl">
                        <span class="text-lg font-bold text-gray-800">Topics Fully Revised (All 4 stages):</span>
                        <span id="topics-revised" class="text-4xl font-extrabold text-green-600">--</span>
                    </div>
                    <div class="flex flex-col p-3 bg-indigo-50 rounded-xl">
                        <span class="text-lg font-bold text-gray-800">Action: Click a bar below to filter syllabus!</span>
                        <span class="text-md text-indigo-600 mt-1">Filter to see only topics where that stage is **Done**.</span>
                        <span class="text-sm text-indigo-400 mt-1">Click the selected bar again to reset the view.</span>
                    </div>
                </div>
                
                <h3 class="text-2xl font-black text-indigo-700 mb-6 border-b pb-2">Independent Stage Completion Rate</h3>

                <!-- Independent Progress Bars -->
                <div id="independent-progress-bars" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Dynamic bar content will be inserted here by JavaScript -->
                    <div class="p-4 rounded-xl shadow-lg border border-gray-100 bg-white text-center text-gray-500">Loading analysis...</div>
                </div>

                <h3 class="text-xl font-bold text-gray-800 mt-10 mb-4 border-b pb-1">Subject Breakdown (Stages Completed Percentage)</h3>
                <!-- Subject-wise Percentage Breakdown -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <!-- Physics -->
                    <div class="p-3 bg-sky-50 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-sky-700">Physics</span>
                            <span id="physics-progress" class="text-xl font-extrabold text-sky-600">--%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="physics-bar" class="h-2 rounded-full bg-sky-500" style="width: 0%"></div>
                        </div>
                        <span id="physics-total-topics" class="text-xs text-gray-500 mt-1 block">-- Topics</span>
                    </div>

                    <!-- Chemistry -->
                    <div class="p-3 bg-fuchsia-50 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-fuchsia-700">Chemistry</span>
                            <span id="chemistry-progress" class="text-xl font-extrabold text-fuchsia-600">--%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="chemistry-bar" class="h-2 rounded-full bg-fuchsia-500" style="width: 0%"></div>
                        </div>
                        <span id="chemistry-total-topics" class="text-xs text-gray-500 mt-1 block">-- Topics</span>
                    </div>

                    <!-- Mathematics -->
                    <div class="p-3 bg-amber-50 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-amber-700">Mathematics</span>
                            <span id="mathematics-progress" class="text-xl font-extrabold text-amber-600">--%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="mathematics-bar" class="h-2 rounded-full bg-amber-500" style="width: 0%"></div>
                        </div>
                        <span id="mathematics-total-topics" class="text-xs text-gray-500 mt-1 block">-- Topics</span>
                    </div>
                </div>
            </div>

            <!-- Filter Status Display -->
            <div id="filter-status" class="mb-8 hidden">
                <!-- Filter message and reset button will be rendered here -->
            </div>

            <!-- Stage Analysis Card (Completion Summary) -->
            <div id="analysis-container" class="bg-white p-6 rounded-xl shadow-xl mb-10 border-l-4 border-purple-500">
                <h2 class="text-2xl font-black text-purple-700 mb-4">Detailed Completion Breakdown</h2>
                <p class="text-gray-600 mb-6">Tracking how many individual milestones (4 per topic) you have completed.</p>
                
                <div id="stage-analysis-content" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="md:col-span-3 text-center p-8 text-gray-400">Loading analysis...</div>
                </div>
            </div>


            <!-- Syllabus Content -->
            <div id="syllabus-content" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Syllabus content generated by renderSyllabusUI function -->
            </div>

        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center text-sm text-gray-500 border-t pt-4">
            <p>Progress is saved automatically using your unique session ID.</p>
            <p>With ‚ù§Ô∏è from Subhanjan</p>
        </footer>
    </div>
</body>
</html>
