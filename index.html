<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE 4-Stage Independent Progress Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }

        /* Specific colors for stages (used for background and text based on completion) */
        .stage-lecture-color { @apply bg-yellow-500; }
        .stage-practice-color { @apply bg-orange-500; }
        .stage-pyq-color { @apply bg-purple-500; }
        .stage-revision-color { @apply bg-green-500; }

        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; 
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal-backdrop.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transform: translateY(-50px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-backdrop.show .modal-content {
            transform: translateY(0);
        }

        /* Notification Toast Container */
        #notification-container {
            position: fixed; top: 20px; right: 20px; z-index: 60;
            max-width: 90%; width: 350px;
        }
        .notification-toast {
            animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-in forwards 9.5s; /* Increased duration to 9.5s total */
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }

    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // --- GLOBAL FIREBASE/APP VARIABLES (Mandatory) ---
        // Use environment-provided configuration for Firebase
        const systemFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        let firebaseConfig = systemFirebaseConfig;

        // >>> FIX START: Fallback for local testing when __firebase_config is undefined <<<
        if (!firebaseConfig) {
            console.warn("Using Firebase fallback config. Replace these placeholders with your actual config for local testing.");
            // ‚ö†Ô∏è CRITICAL: Replace these placeholder values with your ACTUAL Firebase Web App config
            firebaseConfig = {
                apiKey: "AIzaSyB9wE0qIEvaueXJzLyIQQmvhyGJC6k-j94",
                authDomain: "jee-tracker-ead00.firebaseapp.com",
                projectId: "jee-tracker-ead00",
                storageBucket: "jee-tracker-ead00.firebasestorage.app",
                messagingSenderId: "818054839055",
                appId: "1:818054839055:web:139434c214d335247e5c7a"
            };
        }
        // >>> FIX END <<<

        // Use the system-provided app ID or the projectId from the config
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig?.projectId || 'default-app-id'; 
        
        // Use the system-provided auth token
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        const SESSION_STORAGE_KEY = 'jee_tracker_session_id';

        let app, db, auth, userId = null;
        let sessionId = null; 
        let userProgress = {}; 
        let userProfile = { name: 'Anonymous User', avatar: 'üöÄ' }; 
        let totalTopicsCount = 0;
        let currentFilterKey = null; 

        const AVATAR_EMOJIS = ['üê∂', 'üê±', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêÖ', 'üêò', 'üêí', 'ü¶ñ', 'ü¶ã', 'ü¶â', 'üê¢', 'üçé', 'üçì', 'üçç', 'üçâ', 'ü•ù', 'ü•≠', 'üçá'];
        
        const STAGE_KEYS = [
            { key: 'lecture', label: 'Lecture', colorClass: 'stage-lecture-color' },
            { key: 'practice', label: 'Practice', colorClass: 'stage-practice-color' },
            { key: 'pyq', label: 'PYQ', colorClass: 'stage-pyq-color' },
            { key: 'revision', label: 'Revision', colorClass: 'stage-revision-color' }
        ];

        // --- CORE SYLLABUS STRUCTURE (unchanged) ---
        const JEE_SYLLABUS = {
 ¬† ¬† ¬† ¬† ¬† ¬†Physics: [
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Mechanics", topics: ["Units, Dimensions & Errors","Errors and measurements", "Motion in 1D","Motion in 2D", "Newton's Laws of Motion (NLM)","Work Power Energy","Centre of mass", "Rotational Motion","Mechanical Properties of Solid","Mechanical Properties of Fluid"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Thermodynamics", topics: ["Thermal Properties", "Thermodynamics & KTG"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Waves", topics: ["SHM", "Waves",] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Electro-Magnetism", topics: ["Electrostatics and electrostatic potential", "Current electricity","Capacitor","Magnetism","EMI","Alternating Current"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Optics and Modern Physics", topics: ["Ray Optics", "Wave Optics","Modern Physics","Electromagnetic Waves","Semiconductor"] }
 ¬† ¬† ¬† ¬† ¬† ¬†],
 ¬† ¬† ¬† ¬† ¬† ¬†Chemistry: [
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Physical Chemistry", topics: ["Mole Concept", "Atomic Structure", "Gaseous State","Thermodynamics","Chemical Equilibrium","Ionic Equilibrium","Redox Reaction","Solutions","Electrochemistry","Chemical Kinetics","Surface Chemistry"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Organic Chemistry", topics: ["Nomenclature","General Organic Chemistry (GOC)","Isomerism", "Hydrocarbons","Haloalkane & Haloarenes", "Alcohols, Phenols, Ethers","Aldehyde, Ketone, Carboxylic Acid","Amines","Biomolecules","Chemistry in everyday life","Polymer","Environmental Chemistry"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Inorganic Chemistry", topics: ["Periodic Properties of Elements", "Chemical Bonding","Salt Analysis","Metallurgy", "D and F Block","P block","S block", "Hydrogen"] }
 ¬† ¬† ¬† ¬† ¬† ¬†],
 ¬† ¬† ¬† ¬† ¬† ¬†Mathematics: [
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Algebra", topics: ["Basic Maths","Sets", "Complex Numbers", "Quadratic Equations","Sequence and Series","Permutations and Combinations","Binomial Theorem","Matrices","Determinants","Probability","Statistics"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Trigonometry", topics: ["Trigonometric Functions","Trigonometric Equation","Inverse Trigonometry","Solution Of Triangles"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Calculus", topics: ["Relation and Functions","MOD","Limits, Continuity & Differentiability", "AOD", "Indefinite Integration", "Definite Integration","Area Under Curves","Differential Equation"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Co-Ordinate Geometry", topics: ["Straight Lines","Circles","Parabola","Ellipse","Hyperbola"] },
 ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†{ name: "Vector 3D", topics:["Vector","3 Dimentional Geometry"]}
 ¬† ¬† ¬† ¬† ¬† ¬†]
 ¬† ¬† ¬† ¬†};

        // Calculate total topics once 
        Object.entries(JEE_SYLLABUS).forEach(([subject, groups]) => {
            groups.forEach(group => {
                group.topics.forEach(topic => {
                    totalTopicsCount++;
                });
            });
        });
        
        // --- FIREBASE INITIALIZATION & AUTH (AUTO-SIGN-IN) ---

        function setupUnauthenticatedSession(errorMessage) {
            userId = 'UNAUTHENTICATED';
            
            const authStatusElement = document.getElementById('auth-status');
            authStatusElement.innerHTML = `<span class="font-bold text-red-700">FATAL AUTH ERROR (Saving Disabled):</span> ${errorMessage}. <br> Please check your Firebase configuration and security rules.`;

            document.getElementById('session-display').innerHTML = `
                <span class="text-3xl mr-2">‚ùå</span>
                <div class="text-left">
                    <span class="text-xl font-bold text-red-600">ERROR SESSION</span>
                    <p class="text-sm text-red-400">Saving is disabled.</p>
                </div>
            `;
            
            // Show UI even if unauthenticated, but saving is disabled
            document.getElementById('tracker-ui').classList.remove('hidden');
            renderSyllabusUI();
            updateOverallProgress(); 
        }
        
        async function setupAuthenticatedSession(user) {
            userId = user.uid; 
            
            // Check localStorage for an existing session ID
            const storedSessionId = localStorage.getItem(SESSION_STORAGE_KEY);
            
            if (storedSessionId) {
                // If ID found, load it
                sessionId = storedSessionId;
                document.getElementById('tracker-ui').classList.remove('hidden');
                updateHeaderUI();
                loadProgressData(); 
                document.getElementById('auth-status').textContent = `Session ${sessionId} is loaded. Progress automatically saved.`;
            } else {
                // If no ID found, force user to create/load one
                openSessionSetupModal();
                document.getElementById('auth-status').textContent = `Authentication successful. Please create or load a session ID to begin.`;
            }
        }


        window.onload = async () => {
            try {
                // Check if the user replaced the placeholders
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    throw new Error("Firebase configuration placeholders not replaced. Saving is disabled until fixed.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                let signedInUser = null;

                // Anonymous sign-in is required to get an auth token for database access
                try {
                    if (initialAuthToken) {
                        try {
                            const result = await signInWithCustomToken(auth, initialAuthToken);
                            signedInUser = result.user;
                        } catch (tokenError) {
                            console.warn("Custom token failed. Attempting anonymous sign-in as fallback.");
                            const result = await signInAnonymously(auth); 
                            signedInUser = result.user;
                        }
                    } else {
                        const result = await signInAnonymously(auth);
                        signedInUser = result.user;
                    }
                    
                    if (signedInUser) {
                        await setupAuthenticatedSession(signedInUser);
                    } else {
                        // This case should be rare but catches if sign-in fails silently
                        throw new Error("Authentication process finished without a user.");
                    }

                } catch (authError) {
                    // This catches the 'auth/admin-restricted-operation' if Anonymous Auth is disabled
                    console.error("Authentication Error (Saving Disabled):", authError);
                    setupUnauthenticatedSession(`Authentication Failed. Make sure **Anonymous** sign-in is enabled in Firebase Console. (${authError.code})`);
                }

            } catch (error) {
                // This catches the missing config error
                console.error("Firebase Initialization Error:", error);
                document.getElementById('auth-status').textContent = `CRITICAL ERROR: ${error.message}`;
                setupUnauthenticatedSession(error.message);
            }
        };


        function updateHeaderUI() {
            const headerElement = document.getElementById('session-display');
            
            // Initialize with a default profile if session is new and profile wasn't set by startNewSession
            if (!userProfile.avatar) {
                 userProfile.avatar = generateRandomAvatarEmoji();
            }

            if (sessionId) {
                // Modified: Display Session ID prominently with copy/switch buttons
                headerElement.innerHTML = `
                    <span id="profile-avatar" class="text-3xl mr-2">${userProfile.avatar}</span>
                    <div class="text-left">
                        <div class="flex items-center space-x-2">
                            <span class="text-xl font-bold text-gray-800">${userProfile.name}</span>
                            <button onclick="openNameEditModal('${userProfile.name}')" 
                                    class="text-gray-500 hover:text-indigo-600 transition duration-150 p-1 rounded-full hover:bg-indigo-100" 
                                    title="Edit Profile Name">
                                <!-- Pencil Icon -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
                                    <path d="M17 3a2.85 2.85 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                </svg>
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 flex items-center mt-1">
                            Session ID: <span id="current-session-id" class="font-mono font-semibold text-indigo-600 ml-1 select-all">${sessionId || '...'}</span> 
                            <button onclick="copySessionId()" class="ml-2 px-2 py-0.5 bg-indigo-50 text-indigo-600 text-xs font-semibold rounded-md hover:bg-indigo-100 transition duration-150" title="Copy Session ID">
                                Copy
                            </button>
                            <button onclick="openSessionSetupModal()" class="ml-2 px-2 py-0.5 bg-gray-100 text-gray-600 text-xs font-semibold rounded-md hover:bg-gray-200 transition duration-150" title="Switch Session">
                                Switch
                            </button>
                        </p>
                    </div>
                `;
            } else {
                // Initial loading state or error state
                headerElement.innerHTML = `
                    <span class="text-3xl mr-2">...</span>
                    <div class="text-left">
                        <span class="text-xl font-bold text-gray-800">Choose Session ID...</span>
                        <p class="text-sm text-gray-500">Connecting to database...</p>
                    </div>
                `;
            }
        }

        // --- UTILITY FUNCTIONS ---
        const generateRandomAvatarEmoji = () => {
            const randomIndex = Math.floor(Math.random() * AVATAR_EMOJIS.length);
            return AVATAR_EMOJIS[randomIndex];
        };

        const generateShortSessionId = () => {
            // Generates a 6-character alphanumeric ID
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        };

        const calculatePercentage = (count, total) => total > 0 ? ((count / total) * 100).toFixed(1) : 0;
        
        window.copySessionId = function() {
            const idElement = document.getElementById('current-session-id');
            if (idElement && idElement.textContent) {
                // Use document.execCommand('copy') as navigator.clipboard may fail in iframe
                const tempInput = document.createElement('textarea');
                tempInput.value = idElement.textContent;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showNotification('Copied!', `Session ID **${idElement.textContent}** copied to clipboard.`, 'bg-indigo-600', 3000);
            }
        }


        // --- FIREBASE DATA FUNCTIONS ---

        const getProgressDocRef = () => {
            if (!db || !sessionId) return null;
            // Uses a public collection keyed by the Session ID
            const sessionPath = `/artifacts/${appId}/public/data/jee_sessions`; 
            return doc(db, sessionPath, sessionId);
        };

        const initializeUserProfile = async (name, avatar) => {
            const docRef = getProgressDocRef();
            if (!docRef) return;
            try {
                // Only create document if it doesn't exist
                await setDoc(docRef, { 
                    profile: { name, avatar, createdAt: new Date().toISOString() },
                    topics: {} 
                }, { merge: true }); // Use merge to avoid overwriting existing data if ID was reused
            } catch (error) {
                 console.error("Error initializing user profile:", error);
            }
        };

        const loadProgressData = () => {
            const progressDocRef = getProgressDocRef();
            if (!progressDocRef) {
                renderSyllabusUI();
                updateOverallProgress();
                return;
            }

            onSnapshot(progressDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    if (data.profile) {
                        userProfile.name = data.profile.name || `User ${sessionId}`;
                        userProfile.avatar = data.profile.avatar || generateRandomAvatarEmoji();
                    } else {
                        // Document exists but profile is missing, initialize it now (e.g. if created from an older version)
                        // Use current local profile (set during startNewSession or default)
                        initializeUserProfile(userProfile.name, userProfile.avatar);
                    }

                    userProgress = data.topics || {};

                } else {
                    console.log("No progress document found for this session ID. Creating new profile.");
                    // Set default profile before initialization (only if local profile is not already set)
                    if (userProfile.name === 'Anonymous User') {
                        userProfile.name = `User ${sessionId}`;
                        userProfile.avatar = generateRandomAvatarEmoji();
                    }
                    initializeUserProfile(userProfile.name, userProfile.avatar);
                }
                
                updateHeaderUI();
                renderFilterStatus(); 
                renderSyllabusUI();
                updateOverallProgress();

            }, (error) => {
                // This catches the 'Missing or insufficient permissions' error if rules are strict
                console.error("Error listening to progress data (Permission Denied is common if rules are strict):", error);
                showNotification('Connection Error', 'Failed to listen for real-time updates. Check console for permission issues and ensure **Firestore Rules** are correctly set.', 'bg-red-700');
            });
        };

        window.toggleStageCompletion = function(topicKey, stageKey) {
            if (!sessionId) {
                showNotification('Session Required', 'Please create or load a Session ID first.', 'bg-red-500');
                return;
            }
            if (userId === 'UNAUTHENTICATED') {
                showNotification('Saving Disabled', 'Cannot save progress due to a fatal authentication error.', 'bg-red-500');
                return;
            }

            // Get current status, or default to false
            const isCompleted = userProgress[topicKey]?.[stageKey] || false;
            const newStatus = !isCompleted;
            
            // Optimistically update local state
            userProgress[topicKey] = { ...(userProgress[topicKey] || {}), [stageKey]: newStatus };
            
            // Re-render UI immediately for responsiveness
            renderSyllabusUI();
            updateOverallProgress(); 
            
            // Save to Firestore
            updateProgressInFirestore(topicKey, stageKey, newStatus);
        }

        const updateProgressInFirestore = async (topicKey, stageKey, newStatus) => {
            if (!db || !sessionId) {
                console.error("Cannot save data: Session ID not set.");
                showNotification('Save Error', 'Cannot save data. Session not established.', 'bg-red-500');
                return;
            }

            const docRef = getProgressDocRef();
            
            try {
                // Using updateDoc for topic progress is usually fine since the profile/topics structure exists
                await updateDoc(docRef, { [`topics.${topicKey}.${stageKey}`]: newStatus });
                
                if (stageKey === 'revision' && newStatus) {
                    showNotification('Milestone Achieved!', `Revision for **${topicKey.split('-')[1]}** is complete!`, 'bg-green-600');
                }
            } catch (error) {
                // This catches write failures due to rules
                console.error("Error updating document:", error);
                showNotification('Database Write Failed', 'There was an issue saving your progress. Ensure your **Firestore Rules** are correctly set.', 'bg-red-700');
            }
        };

        // --- SESSION SETUP MODAL LOGIC (NEW) ---
        
        window.openSessionSetupModal = function() {
            // This modal is used for initial setup AND for switching sessions
            document.getElementById('session-setup-modal').classList.add('show');
            document.getElementById('load-session-input').focus();
        }

        function closeSessionSetupModal() {
             // Only allow closing if a session ID is already set (i.e., not the initial mandatory load)
             if (sessionId) {
                 document.getElementById('session-setup-modal').classList.remove('show');
             } else {
                 showNotification('Session Required', 'You must create or load a session ID to begin tracking.', 'bg-yellow-500');
             }
        }

        window.startNewSession = function() {
            if (userId === 'UNAUTHENTICATED') {
                 showNotification('Saving Disabled', 'Cannot create session: fatal authentication error detected.', 'bg-red-500');
                 return;
            }

            const nameInput = document.getElementById('new-session-name-input');
            const newName = nameInput.value.trim();

            if (newName.length < 2 || newName.length > 30) {
                showNotification('Validation Error', 'Session Name must be between 2 and 30 characters.', 'bg-yellow-500');
                return;
            }


            const newId = generateShortSessionId();
            localStorage.setItem(SESSION_STORAGE_KEY, newId);
            sessionId = newId;
            closeSessionSetupModal();
            
            // Set the user profile based on input
            userProfile.name = newName;
            userProfile.avatar = generateRandomAvatarEmoji();

            document.getElementById('tracker-ui').classList.remove('hidden');
            updateHeaderUI();
            loadProgressData();
            
            // IMPORTANT: Updated instruction to tell the user to copy the ID
            showNotification(
                'Session Created! **CRITICAL STEP**', 
                `Welcome, **${newName}**! Your unique Session ID is **${newId}**. You **MUST** click the 'Copy' button in the header now to save this ID.`, 
                'bg-green-600', 
                10000 // Long display time for critical instruction
            );
            document.getElementById('auth-status').textContent = `Session ${sessionId} is loaded. Progress automatically saved.`;
        }

        window.loadExistingSession = function() {
            if (userId === 'UNAUTHENTICATED') {
                 showNotification('Saving Disabled', 'Cannot load session: fatal authentication error detected.', 'bg-red-500');
                 return;
            }
            const input = document.getElementById('load-session-input');
            const inputId = input.value.trim().toUpperCase();

            if (inputId.length !== 6 || !/^[A-Z0-9]{6}$/.test(inputId)) {
                showNotification('Invalid ID', 'Session ID must be exactly 6 alphanumeric characters.', 'bg-red-500');
                return;
            }
            
            // Set the ID, save to storage, and reload data
            localStorage.setItem(SESSION_STORAGE_KEY, inputId);
            sessionId = inputId;
            // Reset local profile to trigger full load from Firestore
            userProfile = { name: 'Anonymous User', avatar: 'üöÄ' }; 
            
            closeSessionSetupModal();
            
            document.getElementById('tracker-ui').classList.remove('hidden');
            updateHeaderUI();
            loadProgressData(); // This will now fetch data for the new sessionId
            showNotification('Session Loaded', `Data loaded for Session ID **${inputId}**.`, 'bg-indigo-600', 5000);
            document.getElementById('auth-status').textContent = `Session ${sessionId} is loaded. Progress automatically saved.`;
        }


        // --- NAME EDIT MODAL LOGIC ---

        window.openNameEditModal = function(currentName) {
            if (!sessionId) {
                 showNotification('Session Required', 'Please create or load a Session ID first.', 'bg-red-500');
                 return;
            }
            if (userId === 'UNAUTHENTICATED') {
                 showNotification('Saving Disabled', 'Cannot update profile: fatal authentication error detected.', 'bg-red-500');
                 return;
            }

            const modal = document.getElementById('name-edit-modal');
            const input = document.getElementById('new-name-input');
            
            input.value = currentName;
            modal.classList.add('show');
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveNewUserName();
                }
            };
            input.focus();
        }

        window.closeNameEditModal = function() {
            document.getElementById('name-edit-modal').classList.remove('show');
        }

        window.saveNewUserName = async function() {
            const input = document.getElementById('new-name-input');
            let newName = input.value.trim();
            
            if (newName.length < 2 || newName.length > 30) {
                showNotification('Validation Error', 'Name must be between 2 and 30 characters.', 'bg-yellow-500');
                return;
            }

            if (newName === userProfile.name) {
                closeNameEditModal();
                return; 
            }
            
            const docRef = getProgressDocRef();
            if (!docRef) {
                showNotification('Save Error', 'Cannot save data. Session not established.', 'bg-red-500');
                return;
            }
            
            try {
                // Use setDoc with merge: true to ensure the document exists and safely update the nested 'profile.name' field.
                await setDoc(docRef, { 
                    profile: { name: newName } 
                }, { merge: true });

                userProfile.name = newName; 
                updateHeaderUI(); 
                closeNameEditModal();
                showNotification('Success', `Profile name updated to **${newName}**!`, 'bg-indigo-600');
            } catch (error) {
                console.error("Error updating profile name:", error);
                showNotification('Database Write Failed', 'Could not save new name. Ensure your **Firestore Rules** are correctly set.', 'bg-red-700');
            }
        }


        // --- FILTER LOGIC ---
        window.setFilter = function(stageKey) {
            if (currentFilterKey === stageKey) {
                currentFilterKey = null;
            } else {
                currentFilterKey = stageKey;
            }
            renderFilterStatus(); 
            renderSyllabusUI(); 
            updateOverallProgress(); 
        }

        function renderFilterStatus() {
            const filterStatus = document.getElementById('filter-status');
            if (currentFilterKey === null) {
                filterStatus.classList.add('hidden');
                filterStatus.innerHTML = '';
            } else {
                const stage = STAGE_KEYS.find(s => s.key === currentFilterKey);
                filterStatus.classList.remove('hidden');
                filterStatus.innerHTML = `
                    <div class="flex items-center justify-between w-full p-4 bg-yellow-100 rounded-xl shadow border border-yellow-300">
                        <span class="font-bold text-lg text-yellow-800">Filter Active:</span> 
                        <span class="text-md text-yellow-700">Showing only topics where **${stage.label}** is completed.</span>
                        <button onclick="setFilter(null)" class="ml-4 px-3 py-1 bg-red-500 text-white text-sm font-semibold rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
                            Reset Filter ‚ùå
                        </button>
                    </div>
                `;
            }
        }


        // --- UI RENDERING & LOGIC ---

        function showNotification(title, message, bgColor, duration = 4000) {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            // Notification toast CSS ensures it slides out after 9.5s total (duration + 0.5s fadeOut)
            const animationDuration = (duration / 1000) - 0.5; // Seconds before fadeOut starts
            toast.className = `p-4 mb-3 rounded-lg shadow-xl text-white ${bgColor}`;
            toast.style.animation = `slideIn 0.3s ease-out, fadeOut 0.5s ease-in forwards ${animationDuration}s`;

            toast.innerHTML = `
                <div class="font-bold text-lg mb-1">${title}</div>
                <div class="text-sm">${message}</div>
            `;
            
            container.appendChild(toast);

            // Manual removal after animation finishes
            setTimeout(() => {
                toast.remove();
            }, duration); 
        }

        function updateOverallProgress() {
            let analysis = {
                totalTopics: totalTopicsCount,
                completedRevisionTopics: 0,
                
                progressByStage: STAGE_KEYS.reduce((acc, stage) => {
                    acc[stage.key] = { label: stage.label, count: 0, percentage: 0, colorClass: stage.colorClass };
                    return acc;
                }, {}),

                subjects: { Physics: { totalTopics: 0, completedStages: 0, percentage: 0 }, Chemistry: { totalTopics: 0, completedStages: 0, percentage: 0 }, Mathematics: { totalTopics: 0, completedStages: 0, percentage: 0 } }
            };
            
            // Loop through the syllabus structure to calculate progress (Subject is correctly defined here)
            Object.entries(JEE_SYLLABUS).forEach(([subject, groups]) => {
                groups.forEach(group => {
                    group.topics.forEach(topic => {
                        const topicKey = `${subject}-${topic}`;
                        const progress = userProgress[topicKey] || {};
                        
                        let completedStagesForTopic = 0;

                        STAGE_KEYS.forEach(stage => {
                            if (progress[stage.key]) {
                                analysis.progressByStage[stage.key].count++;
                                completedStagesForTopic++;
                            }
                        });

                        analysis.subjects[subject].totalTopics++;
                        analysis.subjects[subject].completedStages += completedStagesForTopic;

                        if (progress.revision) {
                            analysis.completedRevisionTopics++;
                        }
                    });
                });
            });

            // Calculate percentages for the 4 independent bars
            STAGE_KEYS.forEach(stage => {
                analysis.progressByStage[stage.key].percentage = calculatePercentage(analysis.progressByStage[stage.key].count, totalTopicsCount);
            });


            // 3. Update UI (Header Stats)
            const topicsRevisedDisplay = document.getElementById('topics-revised');
            const totalTopicsDisplay = document.getElementById('total-topics');
            
            if (topicsRevisedDisplay) {
                topicsRevisedDisplay.textContent = `${analysis.completedRevisionTopics}`;
                totalTopicsDisplay.textContent = `${totalTopicsCount}`;
            }

            // Render the 4 independent progress bars with click handlers and active state
            const progressContainer = document.getElementById('independent-progress-bars');
            if (progressContainer) {
                let barsHtml = '';
                STAGE_KEYS.forEach(stageData => {
                    
                    const metrics = analysis.progressByStage[stageData.key]; 
                    
                    let hexColor;
                    if (stageData.key === 'lecture') hexColor = '#f59e0b'; // Tailwind yellow-600
                    else if (stageData.key === 'practice') hexColor = '#f97316'; // Tailwind orange-600
                    else if (stageData.key === 'pyq') hexColor = '#9333ea'; // Tailwind purple-600
                    else if (stageData.key === 'revision') hexColor = '#10b981'; // Tailwind green-600
                    else hexColor = '#6b7280'; // gray-500 fallback

                    const activeClass = currentFilterKey === stageData.key 
                        ? 'ring-4 ring-indigo-400/50 scale-[1.01] shadow-2xl ring-offset-2' 
                        : 'hover:shadow-xl hover:scale-[1.01] transition-all duration-200 cursor-pointer';
                    
                    const indicator = `<span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${hexColor}"></span>`;

                    barsHtml += `
                        <div onclick="setFilter('${stageData.key}')" class="p-4 rounded-xl shadow-lg border-t-4 bg-white ${activeClass}" style="border-top-color: ${hexColor}">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                    ${indicator} ${stageData.label} Completed
                                </h3>
                                <span class="text-2xl font-extrabold text-indigo-600">${metrics.percentage}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="h-3 rounded-full transition-all duration-500 ease-out ${stageData.colorClass.replace('stage-', 'bg-')}" 
                                     style="width: ${metrics.percentage}%">
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">${metrics.count} / ${totalTopicsCount} Topics Completed.</p>
                            <p class="text-xs text-gray-400 mt-1">Click to filter topics where **${stageData.label}** is done.</p>
                        </div>
                    `;
                });
                progressContainer.innerHTML = barsHtml;
            }

            // Update Subject Breakdown
            Object.keys(analysis.subjects).forEach(subject => {
                const data = analysis.subjects[subject];
                const totalSubMilestones = data.totalTopics * STAGE_KEYS.length; 
                data.percentage = calculatePercentage(data.completedStages, totalSubMilestones);
                
                if(document.getElementById(`${subject.toLowerCase()}-progress`)) {
                    document.getElementById(`${subject.toLowerCase()}-progress`).textContent = `${data.percentage}%`;
                    document.getElementById(`${subject.toLowerCase()}-total-topics`).textContent = `${data.totalTopics} Topics`;
                    document.getElementById(`${subject.toLowerCase()}-bar`).style.width = `${data.percentage}%`;
                }
            });
            
            renderStageAnalysis(analysis);
        }

        function renderStageAnalysis(analysis) {
             const stageAnalysisContainer = document.getElementById('stage-analysis-content');
             if (!stageAnalysisContainer) return;
             
             let overallHtml = STAGE_KEYS.map(stage => {
                const count = analysis.progressByStage[stage.key].count;
                const percentage = analysis.progressByStage[stage.key].percentage;
                return `
                    <div class="flex flex-col p-4 ${stage.colorClass.replace('stage-', 'bg-').replace('500', '100')} rounded-lg shadow-inner">
                        <span class="text-2xl font-extrabold ${stage.colorClass.replace('stage-', 'text-')}" >${percentage}%</span>
                        <span class="text-sm font-semibold text-gray-800">${count} Topics done with ${stage.label}</span>
                    </div>
                `;
             }).join('');


            let subjectHtml = Object.entries(analysis.subjects).map(([subject, data]) => {
                const totalStages = data.totalTopics * STAGE_KEYS.length;
                const remainingStages = totalStages - data.completedStages;
                
                return `
                    <div class="p-4 bg-white rounded-xl shadow-lg border-t-4 border-sky-500">
                        <h4 class="text-xl font-bold text-sky-800 mb-3">${subject} (${data.totalTopics} Topics)</h4>
                        <div class="text-2xl font-extrabold text-green-600">${data.completedStages}</div>
                        <p class="text-sm font-medium text-gray-700">Stages Completed / ${totalStages}</p>
                        <div class="text-xl font-extrabold text-red-600 mt-2">${remainingStages}</div>
                        <p class="text-sm font-medium text-gray-700">Stages Remaining</p>
                    </div>
                `;
            }).join('');

            stageAnalysisContainer.innerHTML = `
                <div class="md:col-span-3">
                    <h3 class="text-2xl font-extrabold text-indigo-700 mb-4 border-b pb-2">Overall Completion Status</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-indigo-50 rounded-xl shadow-inner mb-6">
                        ${overallHtml}
                    </div>
                </div>
                ${subjectHtml}
            `;
        }


        function renderSyllabusUI() {
            const container = document.getElementById('syllabus-content');
            container.innerHTML = ''; 

            let anyTopicVisible = false;
            
            Object.entries(JEE_SYLLABUS).forEach(([subject, groups]) => {
                const subjectCard = document.createElement('div');
                subjectCard.className = 'bg-white p-4 sm:p-6 rounded-xl shadow-2xl border-t-8 border-sky-600 transition duration-500 hover:shadow-sky-300/50';

                const subjectTitle = document.createElement('h2');
                subjectTitle.className = 'text-2xl sm:text-3xl font-extrabold text-sky-700 mb-4 border-b-2 pb-2';
                subjectTitle.textContent = subject;
                subjectCard.appendChild(subjectTitle);

                let subjectHasVisibleTopics = false;

                groups.forEach(group => {
                    const groupSection = document.createElement('div');
                    groupSection.className = 'mb-6 p-4 bg-gray-50 rounded-xl shadow-inner';

                    const groupTitle = document.createElement('h3');
                    groupTitle.className = 'text-lg font-bold text-sky-800 mb-3 border-b pb-1';
                    groupTitle.textContent = group.name;
                    groupSection.appendChild(groupTitle);
                    
                    let groupHasVisibleTopics = false;
                    const topicsList = document.createElement('div');
                    topicsList.className = 'space-y-3';


                    group.topics.forEach(topic => {
                        const topicKey = `${subject}-${topic}`;
                        const progress = userProgress[topicKey] || {};
                        
                        // Filter Logic: Only show topic if no filter is active OR if the specific stage is completed (true)
                        const isVisible = currentFilterKey === null || progress[currentFilterKey] === true;

                        if (isVisible) {
                            groupHasVisibleTopics = true;
                            subjectHasVisibleTopics = true;
                            anyTopicVisible = true;
                            
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 rounded-lg bg-white border border-gray-100 shadow-sm';

                            const label = document.createElement('span');
                            const isFullyComplete = STAGE_KEYS.every(s => progress[s.key]);
                            label.className = `text-base font-medium text-gray-800 w-full sm:w-1/2 mr-4 ${isFullyComplete ? 'line-through text-gray-500' : ''}`;
                            label.textContent = topic;
                            itemDiv.appendChild(label);

                            const stageToggles = document.createElement('div');
                            stageToggles.className = 'flex flex-wrap justify-start sm:justify-end space-x-2 p-1 bg-gray-100 rounded-md mt-2 sm:mt-0 shadow-inner';

                            STAGE_KEYS.forEach(stage => {
                                const isChecked = progress[stage.key] || false;
                                
                                const stageWrapper = document.createElement('div');
                                stageWrapper.className = 'relative';

                                const checkboxId = `${topicKey}-${stage.key}-check`;
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.id = checkboxId;
                                checkbox.checked = isChecked;
                                checkbox.className = 'sr-only peer'; 
                                checkbox.onclick = () => toggleStageCompletion(topicKey, stage.key);
                                
                                const label = document.createElement('label');
                                label.htmlFor = checkboxId;
                                
                                const baseClasses = 'px-3 py-1 text-xs font-medium rounded-full cursor-pointer transition-all duration-200 flex items-center shadow-sm whitespace-nowrap';
                                
                                const checkedClasses = `peer-checked:text-gray-500 peer-checked:line-through peer-checked:${stage.colorClass.replace('stage-', 'bg-')} peer-checked:shadow-md`;
                                const uncheckedClasses = `peer-not-checked:bg-white peer-not-checked:text-gray-600 peer-not-checked:border peer-not-checked:border-gray-300 hover:bg-gray-100`;

                                label.className = `${baseClasses} ${checkedClasses} ${uncheckedClasses}`;

                                const currentIsChecked = userProgress[topicKey]?.[stage.key] || false;
                                label.innerHTML = `
                                    <span class="text-sm mr-1">${currentIsChecked ? '‚úì' : '‚òê'}</span> 
                                    <span>${stage.label}</span>
                                `;

                                stageWrapper.appendChild(checkbox);
                                stageWrapper.appendChild(label);
                                stageToggles.appendChild(stageWrapper);
                            });

                            itemDiv.appendChild(stageToggles);
                            topicsList.appendChild(itemDiv);
                        }
                    });

                    if (groupHasVisibleTopics) {
                        groupSection.appendChild(topicsList);
                        subjectCard.appendChild(groupSection);
                    }
                });
                
                if (subjectHasVisibleTopics) {
                    container.appendChild(subjectCard);
                }
            });
            
            if (!anyTopicVisible && currentFilterKey !== null) {
                container.innerHTML = `<div class="md:col-span-3 text-center p-12 bg-yellow-50 rounded-xl shadow-inner border-y-4 border-yellow-300">
                    <h3 class="text-2xl font-bold text-yellow-800 mb-2">No Topics Found</h3>
                    <p class="text-lg text-yellow-700">There are no topics currently marked as **${STAGE_KEYS.find(s => s.key === currentFilterKey).label}** complete.</p>
                </div>`;
            } else if (!anyTopicVisible && currentFilterKey === null && totalTopicsCount === 0) {
                 container.innerHTML = `<div class="md:col-span-3 text-center p-12 bg-yellow-50 rounded-xl shadow-inner border-y-4 border-yellow-300">
                    <h3 class="text-2xl font-bold text-yellow-800 mb-2">Syllabus Missing</h3>
                    <p class="text-lg text-yellow-700">The syllabus definition is empty. Please check the 'JEE_SYLLABUS' object in the code.</p>
                </div>`;
            }
        };

    </script>
</head>
<body class="min-h-screen">
    <div id="notification-container">
        <!-- Toast notifications appear here -->
    </div>
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-8 sm:mb-10 bg-white p-4 sm:p-6 rounded-xl shadow-lg border-b-4 border-indigo-600 flex justify-between items-center">
            <div>
                <h1 class="text-3xl sm:text-4xl font-black text-indigo-700 mb-1">JEE Independent Stage Tracker</h1>
                <p class="text-base sm:text-lg text-gray-600">Mark **Lecture, Practice, PYQ, and Revision** independently for each topic.</p>
            </div>
            <div id="session-display" class="flex items-center p-2 bg-indigo-50 rounded-lg shadow-inner">
                <span class="text-3xl mr-2">...</span>
                <div class="text-left">
                    <span class="text-xl font-bold text-gray-800">Choose Session ID...</span>
                    <p class="text-sm text-gray-500">Connecting to database...</p>
                </div>
            </div>
        </header>

        <!-- Status Bar -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 p-3 bg-indigo-50 rounded-lg shadow-inner text-sm text-indigo-700">
            <span id="auth-status" class="font-medium">Initializing connection for automatic saving...</span>
        </div>

        <!-- MAIN TRACKER UI (Initially hidden until a Session ID is chosen) -->
        <div id="tracker-ui" class="hidden">
            
            <!-- Overall Progress Card -->
            <div id="progress-container" class="bg-white p-6 rounded-xl shadow-xl mb-10 border-l-4 border-indigo-500">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="flex flex-col p-3 bg-blue-50 rounded-xl">
                        <span class="text-lg font-bold text-gray-800">Total Topics in Syllabus:</span>
                        <span id="total-topics" class="text-4xl font-extrabold text-blue-600">--</span>
                    </div>
                    <div class="flex flex-col p-3 bg-green-50 rounded-xl">
                        <span class="text-lg font-bold text-gray-800">Topics Fully Revised (All 4 stages):</span>
                        <span id="topics-revised" class="text-4xl font-extrabold text-green-600">--</span>
                    </div>
                    <div class="flex flex-col p-3 bg-indigo-50 rounded-xl">
                        <span class="text-lg font-bold text-gray-800">Action: Click a bar below to filter syllabus!</span>
                        <span class="text-md text-indigo-600 mt-1">Filter to see only topics where that stage is **Done**.</span>
                        <span class="text-sm text-indigo-400 mt-1">Click the selected bar again to reset the view.</span>
                    </div>
                </div>
                
                <h3 class="text-2xl font-black text-indigo-700 mb-6 border-b pb-2">Independent Stage Completion Rate</h3>

                <!-- Independent Progress Bars -->
                <div id="independent-progress-bars" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="p-4 rounded-xl shadow-lg border border-gray-100 bg-white text-center text-gray-500">Loading analysis...</div>
                </div>

                <h3 class="text-xl font-bold text-gray-800 mt-10 mb-4 border-b pb-1">Subject Breakdown (Stages Completed Percentage)</h3>
                <!-- Subject-wise Percentage Breakdown -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <!-- Physics -->
                    <div class="p-3 bg-sky-50 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-sky-700">Physics</span>
                            <span id="physics-progress" class="text-xl font-extrabold text-sky-600">--%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="physics-bar" class="h-2 rounded-full bg-sky-500" style="width: 0%"></div>
                        </div>
                        <span id="physics-total-topics" class="text-xs text-gray-500 mt-1 block">-- Topics</span>
                    </div>

                    <!-- Chemistry -->
                    <div class="p-3 bg-fuchsia-50 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-fuchsia-700">Chemistry</span>
                            <span id="chemistry-progress" class="text-xl font-extrabold text-fuchsia-600">--%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="chemistry-bar" class="h-2 rounded-full bg-fuchsia-500" style="width: 0%"></div>
                        </div>
                        <span id="chemistry-total-topics" class="text-xs text-gray-500 mt-1 block">-- Topics</span>
                    </div>

                    <!-- Mathematics -->
                    <div class="p-3 bg-amber-50 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-amber-700">Mathematics</span>
                            <span id="mathematics-progress" class="text-xl font-extrabold text-amber-600">--%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="mathematics-bar" class="h-2 rounded-full bg-amber-500" style="width: 0%"></div>
                        </div>
                        <span id="mathematics-total-topics" class="text-xs text-gray-500 mt-1 block">-- Topics</span>
                    </div>
                </div>
            </div>

            <!-- Filter Status Display -->
            <div id="filter-status" class="mb-8 hidden">
                <!-- Filter message and reset button will be rendered here -->
            </div>

            <!-- Stage Analysis Card (Completion Summary) -->
            <div id="analysis-container" class="bg-white p-6 rounded-xl shadow-xl mb-10 border-l-4 border-purple-500">
                <h2 class="text-2xl font-black text-purple-700 mb-4">Detailed Completion Breakdown</h2>
                <p class="text-gray-600 mb-6">Tracking how many individual milestones (4 per topic) you have completed.</p>
                
                <div id="stage-analysis-content" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="md:col-span-3 text-center p-8 text-gray-400">Loading analysis...</div>
                </div>
            </div>


            <!-- Syllabus Content -->
            <div id="syllabus-content" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Syllabus content generated by renderSyllabusUI function -->
            </div>

        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center text-sm text-gray-500 border-t pt-4">
            <p>Progress is saved automatically using your unique session ID.</p>
        </footer>
    </div>
    
    <!-- --- SESSION SETUP MODAL UI (Appears on first load or on 'Switch' click) --- -->
    <div id="session-setup-modal" class="modal-backdrop">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full text-center relative">
            
            <!-- ADDED CROSS BUTTON for Session Setup Modal -->
            <button onclick="closeSessionSetupModal()" 
                    class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition duration-150 p-2 rounded-full hover:bg-gray-100"
                    title="Close">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            
            <h3 class="text-3xl font-black text-indigo-700 mb-4 border-b pb-2">Load or Create Your Study Session</h3>
            <p class="text-gray-600 mb-6">Your progress is saved using a unique 6-character Session ID. Use this ID to sync your data across all your devices.</p>

            <div class="flex flex-col space-y-4">
                <div class="p-6 bg-indigo-50 rounded-xl border border-indigo-200">
                    <h4 class="text-xl font-bold text-indigo-700 mb-3">1. Load Existing Session</h4>
                    <input type="text" id="load-session-input" 
                           class="w-full p-3 mb-3 border border-gray-300 rounded-lg text-center text-lg font-mono uppercase focus:ring-indigo-500 focus:border-indigo-500" 
                           placeholder="ENTER 6-CHARACTER ID (E.G., A1B2C3)" maxlength="6">
                    <button onclick="loadExistingSession()" 
                            class="w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                        Load Session
                    </button>
                </div>
                
                <!-- UPDATED SECTION: Added Name Input -->
                <div class="p-6 bg-gray-50 rounded-xl border border-gray-200">
                    <h4 class="text-xl font-bold text-gray-700 mb-3">2. Start New Session</h4>
                    <p class="text-sm text-gray-500 mb-2">Enter a name for your session (e.g., My 2026 JEE Prep).</p>
                    <input type="text" id="new-session-name-input" 
                           class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-lg font-medium focus:ring-green-500 focus:border-green-500" 
                           placeholder="Your Name / Session Name" maxlength="30">
                    <button onclick="startNewSession()" 
                            class="w-full px-4 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150">
                        Create New ID & Start
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- --- NAME EDIT MODAL UI --- -->
    <div id="name-edit-modal" class="modal-backdrop">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full relative">
            
            <!-- CROSS BUTTON for Name Edit Modal (Also added for consistency) -->
            <button onclick="closeNameEditModal()" 
                    class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition duration-150 p-2 rounded-full hover:bg-gray-100"
                    title="Close">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <h3 class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">Change Your Profile Name</h3>
            
            <p class="text-sm text-gray-600 mb-4">This name is used to identify your session. (2-30 characters)</p>

            <input type="text" id="new-name-input" 
                   class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg font-medium" 
                   placeholder="Enter new name" maxlength="30">
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeNameEditModal()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
                    Cancel
                </button>
                <button onclick="saveNewUserName()" 
                        class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                    Save Name
                </button>
            </div>
        </div>
    </div>
</body>
</html>
