<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRAXIS | Experience Elevated</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@800&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --brand: #8b5cf6; }
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #fff; overflow-x: hidden; }
        h1, h2, h3 { font-family: 'Syne', sans-serif; }
        .mesh-gradient { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 0% 0%, rgba(139, 92, 246, 0.15) 0%, transparent 35%), radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.12) 0%, transparent 35%); z-index: -1; }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .btn-premium { background: #fff; color: #000; transition: all 0.3s ease; cursor: pointer; border: none; font-weight: 900; text-transform: uppercase; }
        .btn-premium:hover:not(:disabled) { background: var(--brand); color: #fff; box-shadow: 0 0 25px rgba(139, 92, 246, 0.4); }

        .hero-container { position: relative; min-height: 180px; display: flex; align-items: flex-start; margin-bottom: 2rem; }
        #typewriter { border-right: 3px solid var(--brand); padding-right: 8px; }
        .cursor-blink { animation: blink 0.8s infinite; }
        @keyframes blink { 0%, 100% { border-color: var(--brand); } 50% { border-color: transparent; } }

        #account-panel { transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1); z-index: 500; }
        .hidden { display: none !important; }
        .tier-active { border-color: var(--brand) !important; background: rgba(139, 92, 246, 0.1) !important; }
        .history-card { opacity: 0.4; filter: grayscale(1); }

        .timer-bar-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-top: 10px; }
        #timer-bar-fill { width: 0%; height: 100%; background: var(--brand); }
    </style>
</head>
<body class="bg-black">
    <div class="mesh-gradient"></div>

    <nav class="fixed top-0 w-full z-[100] bg-black/50 backdrop-blur-lg border-b border-white/5 px-8 py-4 flex justify-between items-center">
        <img src="images/praxiswhite.png" alt="PRAXIS." class="h-8 cursor-pointer" onclick="location.reload()" onerror="this.style.display='none'; this.after('PRAXIS.')">
        <div class="flex items-center gap-6">
            <button id="nav-login-btn" onclick="openAuth()" class="text-[10px] font-bold uppercase tracking-widest">Login</button>
            <button id="nav-acc-btn" onclick="openAccount()" class="hidden btn-premium px-6 py-2 rounded-full text-[10px]">Account</button>
        </div>
    </nav>

    <section class="pt-40 px-8 max-w-7xl mx-auto">
        <div class="hero-container">
            <h1 class="text-6xl md:text-8xl font-black italic uppercase leading-[0.9] tracking-tighter">
                <span id="typewriter" class="cursor-blink"></span>
            </h1>
        </div>
        
        <div class="flex flex-col md:flex-row gap-4 mb-16">
            <input type="text" id="search-input" oninput="filterEvents()" placeholder="Search experiences..." class="glass-card flex-1 px-6 py-4 rounded-2xl outline-none focus:border-purple-500 transition">
            <select id="location-filter" onchange="filterEvents()" class="glass-card px-6 py-4 rounded-2xl outline-none focus:border-purple-500 transition bg-black text-white appearance-none cursor-pointer">
                <option value="all">All Locations</option>
            </select>
        </div>

        <div id="events-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8 pb-20"></div>
    </section>

    <div id="account-panel" class="fixed top-0 right-0 h-full w-full md:w-[450px] bg-black border-l border-white/10 p-10 translate-x-full overflow-y-auto">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-3xl font-black italic uppercase">My Vault</h2>
            <button onclick="closeAccount()" class="text-2xl opacity-40 hover:opacity-100">✕</button>
        </div>
        <h3 class="text-[10px] font-black uppercase tracking-[0.2em] mb-4 text-purple-400">Active passes</h3>
        <div id="active-tickets" class="space-y-4 mb-12"></div>
        <div class="border-t border-white/5 pt-8">
            <h3 class="text-[10px] font-black uppercase tracking-[0.2em] mb-4 opacity-40">All Purchases</h3>
            <div id="history-tickets" class="space-y-4 mb-10"></div>
        </div>
        <button onclick="triggerLogout()" class="w-full py-4 border border-red-500/20 text-red-500 text-[10px] font-black uppercase rounded-2xl hover:bg-red-500/10 transition">Sign Out</button>
    </div>

    <div id="qr-modal" class="fixed inset-0 z-[600] bg-black/98 flex flex-col items-center justify-center hidden">
        <div id="zoom-qr-box" class="bg-white p-6 rounded-3xl mb-8"></div>
        <p class="text-[10px] font-black uppercase tracking-[0.3em] mb-8 text-purple-500">Authorized Pass</p>
        <button onclick="closeQRModal()" class="btn-premium px-12 py-4 rounded-full text-xs">Close</button>
    </div>

    <div id="auth-modal" class="fixed inset-0 z-[200] bg-black/95 backdrop-blur-xl flex items-center justify-center hidden">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-md relative text-center">
            <button onclick="closeAuth()" class="absolute top-6 right-8 opacity-50">✕</button>
            <h2 id="auth-title" class="text-4xl font-black mb-8 italic uppercase">Join.</h2>
            <input id="auth-email" type="email" placeholder="Email" class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 mb-4 outline-none focus:border-purple-500 transition">
            <input id="auth-password" type="password" placeholder="Password" class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 mb-8 outline-none focus:border-purple-500 transition">
            <button onclick="executeAuth()" class="btn-premium w-full py-4 rounded-2xl text-xs">Continue</button>
            <button onclick="toggleAuthMode()" id="toggle-btn" class="text-[10px] opacity-40 uppercase mt-6 block w-full tracking-widest">Need an account?</button>
        </div>
    </div>

    <div id="booking-overlay" class="fixed inset-0 z-[300] bg-black/95 backdrop-blur-2xl flex items-center justify-center hidden">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-lg relative">
            <button onclick="closeBooking()" class="absolute top-6 right-8 opacity-40">✕</button>
            <div id="step-select">
                <h2 class="text-3xl font-black italic uppercase mb-2">Reserve Spot</h2>
                <p id="book-event-name" class="text-purple-400 font-bold uppercase text-[10px] mb-8"></p>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button id="tier-std" onclick="setTier('Standard')" class="p-4 border border-white/10 rounded-2xl text-left tier-active"><b class="block uppercase italic text-[10px]">Standard</b><span class="font-black opacity-60" id="price-std">₹---</span></button>
                    <button id="tier-vip" onclick="setTier('VIP')" class="p-4 border border-white/10 rounded-2xl text-left"><b class="block uppercase italic text-[10px]">VIP Access</b><span class="font-black opacity-60" id="price-vip">₹---</span></button>
                </div>
                <input id="verify-email-input" type="email" placeholder="Verification Email" class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 mb-6 outline-none">
                <button onclick="sendBookingOTP()" class="btn-premium w-full py-4 rounded-2xl text-xs">Send OTP</button>
            </div>
            <div id="step-verify" class="hidden text-center">
                <h2 class="text-3xl font-black italic uppercase mb-4">Verify OTP</h2>
                <p class="text-[10px] uppercase tracking-widest opacity-40 mb-6">Expires in: <span id="otp-expiry" class="text-white">05:00</span></p>
                <input id="otp-input" type="text" placeholder="000000" maxlength="6" class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-6 mb-6 text-center text-4xl font-black tracking-widest outline-none">
                <button id="resend-otp-btn" disabled onclick="sendBookingOTP()" class="w-full text-[10px] uppercase font-black opacity-30 cursor-not-allowed mb-2">Resend OTP</button>
                <div class="timer-bar-bg"><div id="timer-bar-fill"></div></div>
                <button onclick="confirmFinalBooking()" class="btn-premium w-full py-4 rounded-2xl text-xs mt-8">Complete Booking</button>
            </div>
        </div>
    </div>

    <footer class="border-t border-white/5 bg-black py-20 px-8">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-start gap-12">
            <div>
                <img src="images/praxiswhite.png" alt="PRAXIS." class="h-10 mb-6" onerror="this.style.display='none'; this.after('PRAXIS.')">
                <p class="text-xs opacity-40 font-medium uppercase tracking-[0.3em]">Experience Elevated.</p>
            </div>
            <div class="grid grid-cols-2 gap-20">
                <div>
                    <h4 class="text-[10px] font-black uppercase tracking-widest mb-6 opacity-20">Contact</h4>
                    <a href="mailto:quizzo2k25@gmail.com" class="text-sm block hover:text-purple-500">quizzo2k25@gmail.com</a>
                </div>
                <div>
                    <h4 class="text-[10px] font-black uppercase tracking-widest mb-6 opacity-20">Social</h4>
                    <div class="flex flex-col gap-3">
                        <a href="https://x.com" target="_blank" class="text-sm">X.com</a>
                        <a href="https://instagram.com" target="_blank" class="text-sm">Instagram</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBDcvXVhv-hn0lTrIxfjrPlp2B5N0Vk_As", authDomain: "praxis-tickets.firebaseapp.com", projectId: "praxis-tickets", storageBucket: "praxis-tickets.firebasestorage.app", messagingSenderId: "865044869844", appId: "1:865044869844:web:7fe4fc422d158f5c2c0141" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        emailjs.init("A9gvj50d9xfwuaCq_");

        let activeBooking = {}, allEvents = [], generatedOTP = null, isSignup = false, currentOpenTicketId = null, unsubscribeVault = null, barAnimReq = null, otpExpiryTimer = null;

        const phrases = ["Live Now.", "Buy Now.", "Feel Now."];
        let i = 0, j = 0, isDeleting = false;
        function type() {
            const current = phrases[i];
            const display = isDeleting ? current.substring(0, j--) : current.substring(0, j++);
            document.getElementById('typewriter').textContent = display;
            if(!isDeleting && j === current.length+1){ isDeleting = true; setTimeout(type, 2000); }
            else if(isDeleting && j === 0){ isDeleting = false; i = (i+1)%phrases.length; setTimeout(type, 500); }
            else { setTimeout(type, isDeleting ? 40 : 80); }
        }
        type();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.email === "admin@praxis.co") window.location.replace("admin.html");
                document.getElementById('nav-login-btn').classList.add('hidden');
                document.getElementById('nav-acc-btn').classList.remove('hidden');
                setupVaultListener(user.uid);
            } else {
                if(unsubscribeVault) unsubscribeVault();
                document.getElementById('nav-login-btn').classList.remove('hidden');
                document.getElementById('nav-acc-btn').classList.add('hidden');
            }
            loadEvents();
        });

        function setupVaultListener(uid) {
            const q = query(collection(db, "tickets"), where("userId", "==", uid));
            unsubscribeVault = onSnapshot(q, (snap) => {
                const activeDiv = document.getElementById('active-tickets');
                const historyDiv = document.getElementById('history-tickets');
                activeDiv.innerHTML = ''; historyDiv.innerHTML = '';
                snap.forEach(d => {
                    const t = d.data(), tid = d.id;
                    if(tid === currentOpenTicketId && t.isUsed) closeQRModal();
                    if (t.status === 'approved' && !t.isUsed) {
                        const card = document.createElement('div');
                        card.className = "glass-card p-5 rounded-3xl flex justify-between items-center cursor-pointer hover:border-purple-500 transition";
                        card.onclick = () => openQR(tid);
                        card.innerHTML = `<div><p class="font-black text-xs uppercase italic">${t.eventName}</p><p class="text-[8px] font-black uppercase text-purple-500 mt-1">AVAILABLE • ₹${t.price}</p></div><div id="sm-${tid}" class="bg-white p-1 rounded-lg"></div>`;
                        activeDiv.appendChild(card);
                        new QRCode(document.getElementById(`sm-${tid}`), { text: tid, width: 35, height: 35 });
                    }
                    const hCard = document.createElement('div');
                    hCard.className = "glass-card history-card p-5 rounded-3xl flex justify-between items-center";
                    hCard.innerHTML = `<div><p class="font-black text-xs uppercase italic">${t.eventName}</p><p class="text-[7px] font-bold uppercase mt-1 opacity-60">${t.isUsed ? "USED" : t.status.toUpperCase()} • ₹${t.price}</p></div>`;
                    historyDiv.appendChild(hCard);
                });
            });
        }

        // --- FIXED LOAD EVENTS TO POPULATE DROPDOWN ---
        async function loadEvents() {
            const snap = await getDocs(collection(db, "events"));
            allEvents = snap.docs.map(d => ({id: d.id, ...d.data()}));
            
            // Get the select element
            const select = document.getElementById('location-filter');
            
            // Clear existing except the first "All Locations"
            select.innerHTML = '<option value="all">All Locations</option>';
            
            // Extract unique cities from your data
            const uniqueCities = [...new Set(allEvents.map(e => e.city))].filter(Boolean);
            
            // Add them to the dropdown
            uniqueCities.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city;
                opt.textContent = city;
                select.appendChild(opt);
            });

            renderEventsGrid(allEvents);
        }

        function renderEventsGrid(data) {
            const grid = document.getElementById('events-grid');
            grid.innerHTML = '';
            data.forEach(ev => {
                // IMAGE PATH FIX: Prepend "images/" to name if only filename exists
                const rawImg = ev.image || '';
                const imgUrl = rawImg.includes('/') ? rawImg : `images/${rawImg}`;
                
                grid.innerHTML += `<div class="glass-card p-6 rounded-[2.5rem] group overflow-hidden">
                    <div class="overflow-hidden rounded-3xl h-56 mb-6">
                        <img src="${imgUrl}" onerror="this.src='https://images.unsplash.com/photo-1492684223066-81342ee5ff30'" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition duration-500">
                    </div>
                    <div class="flex justify-between items-start mb-2">
                         <h3 class="text-2xl font-black italic uppercase">${ev.title}</h3>
                         <span class="text-[8px] bg-purple-500/20 text-purple-400 px-2 py-1 rounded-full font-bold uppercase">${ev.city}</span>
                    </div>
                    <div class="flex gap-4 mb-6">
                        <div>
                             <p class="text-[8px] opacity-30 font-bold uppercase">Experience Date</p>
                             <p class="text-[10px] font-black uppercase text-white">${ev.showTime ? ev.showTime.split('T')[0] : 'TBA'}</p>
                        </div>
                        <div>
                             <p class="text-[8px] opacity-30 font-bold uppercase">Start Time</p>
                             <p class="text-[10px] font-black uppercase text-white">${ev.showTime ? ev.showTime.split('T')[1] || '---' : 'TBA'}</p>
                        </div>
                    </div>
                    <button onclick="bookNow('${ev.id}')" class="btn-premium w-full py-4 rounded-2xl text-[10px]">Book Tickets</button>
                </div>`;
            });
        }

        window.sendBookingOTP = async () => {
            const email = document.getElementById('verify-email-input').value;
            if(!email.includes('@')) return alert("Invalid Email");
            generatedOTP = Math.floor(100000 + Math.random() * 900000);
            try {
                await emailjs.send("service_ctg57ig", "template_6rsdu08", { email, passcode: generatedOTP, time: "5m" });
                startTimers();
                showStep(2);
            } catch(e) { alert("OTP service failed"); }
        };

        // SMOOTH OTP TIMER (60fps)
        function startTimers() {
            if(barAnimReq) cancelAnimationFrame(barAnimReq);
            clearInterval(otpExpiryTimer);
            
            const resendBtn = document.getElementById('resend-otp-btn');
            const bar = document.getElementById('timer-bar-fill');
            const expiryText = document.getElementById('otp-expiry');
            
            resendBtn.disabled = true;
            resendBtn.classList.add('opacity-30', 'cursor-not-allowed');

            let startTime = Date.now();
            let duration = 60000; // 60 seconds

            function updateBar() {
                let elapsed = Date.now() - startTime;
                let progress = Math.min((elapsed / duration) * 100, 100);
                bar.style.width = progress + "%";
                
                if (progress < 100) {
                    barAnimReq = requestAnimationFrame(updateBar);
                } else {
                    resendBtn.disabled = false;
                    resendBtn.classList.remove('opacity-30', 'cursor-not-allowed');
                    resendBtn.classList.add('opacity-100');
                }
            }
            barAnimReq = requestAnimationFrame(updateBar);

            let expirySec = 300;
            otpExpiryTimer = setInterval(() => {
                expirySec--;
                let m = Math.floor(expirySec / 60), s = expirySec % 60;
                expiryText.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                if(expirySec <= 0) { clearInterval(otpExpiryTimer); generatedOTP = null; alert("OTP Expired"); }
            }, 1000);
        }

        window.bookNow = (id) => {
            if(!auth.currentUser) return openAuth();
            const ev = allEvents.find(e => e.id === id);
            activeBooking = { id: ev.id, title: ev.title, prices: ev.prices || { standard: 3999, vip: 9999 }, tier: 'Standard' };
            activeBooking.price = activeBooking.prices.standard;
            document.getElementById('book-event-name').innerText = ev.title;
            document.getElementById('price-std').innerText = `₹${activeBooking.prices.standard}`;
            document.getElementById('price-vip').innerText = `₹${activeBooking.prices.vip}`;
            document.getElementById('booking-overlay').classList.remove('hidden');
            showStep(1);
        };

        window.confirmFinalBooking = async () => {
            if(document.getElementById('otp-input').value != generatedOTP) return alert("Wrong OTP");
            await addDoc(collection(db, "tickets"), { userId: auth.currentUser.uid, buyerEmail: auth.currentUser.email, eventName: activeBooking.title, eventDocId: activeBooking.id, tier: activeBooking.tier, price: activeBooking.price, status: "pending", isUsed: false, timestamp: Date.now() });
            alert("Requested!"); location.reload();
        };

        window.openQR = (tid) => { currentOpenTicketId = tid; const box = document.getElementById('zoom-qr-box'); box.innerHTML = ''; document.getElementById('qr-modal').classList.remove('hidden'); setTimeout(() => { new QRCode(box, { text: tid, width: 220, height: 220 }); }, 200); };
        window.closeQRModal = () => { currentOpenTicketId = null; document.getElementById('qr-modal').classList.add('hidden'); };
        window.openAuth = () => document.getElementById('auth-modal').classList.remove('hidden');
        window.closeAuth = () => document.getElementById('auth-modal').classList.add('hidden');
        window.openAccount = () => document.getElementById('account-panel').classList.remove('translate-x-full');
        window.closeAccount = () => document.getElementById('account-panel').classList.add('translate-x-full');
        window.closeBooking = () => document.getElementById('booking-overlay').classList.add('hidden');
        window.showStep = (s) => { document.getElementById('step-select').classList.toggle('hidden', s !== 1); document.getElementById('step-verify').classList.toggle('hidden', s !== 2); };
        window.setTier = (t) => { activeBooking.tier = t; activeBooking.price = t === 'Standard' ? activeBooking.prices.standard : activeBooking.prices.vip; document.getElementById('tier-std').classList.toggle('tier-active', t === 'Standard'); document.getElementById('tier-vip').classList.toggle('tier-active', t === 'VIP'); };
        window.toggleAuthMode = () => { isSignup = !isSignup; document.getElementById('auth-title').innerText = isSignup ? "Create." : "Join."; };
        window.executeAuth = async () => { const e = document.getElementById('auth-email').value, p = document.getElementById('auth-password').value; try { if(isSignup) await createUserWithEmailAndPassword(auth, e, p); else await signInWithEmailAndPassword(auth, e, p); location.reload(); } catch(e) { alert(e.message); } };
        window.triggerLogout = async () => { await signOut(auth); location.reload(); };
        window.filterEvents = () => { const s = document.getElementById('search-input').value.toLowerCase(), l = document.getElementById('location-filter').value; const f = allEvents.filter(e => e.title.toLowerCase().includes(s) && (l === 'all' || e.city === l)); renderEventsGrid(f); };
    </script>
</body>
</html>

