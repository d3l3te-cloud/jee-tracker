<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PRAXIS | Admin Control</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@800&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body { background:#050505; color:white; font-family:'Inter',sans-serif }
.glass { background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.08); backdrop-filter:blur(20px) }
input { background:rgba(255,255,255,0.05)!important; border:1px solid rgba(255,255,255,0.1)!important; color:white!important; padding:12px; border-radius:12px }
</style>
</head>

<body class="p-6 md:p-12">
<div class="max-w-7xl mx-auto">

<h1 class="text-4xl font-black italic uppercase mb-10">
Admin <span class="text-purple-500">Dash</span>
</h1>

<!-- STATS -->
<div class="grid grid-cols-4 gap-6 mb-12">
<div class="glass p-6 rounded-2xl"><p>Revenue</p><h2 id="total-revenue">₹0</h2></div>
<div class="glass p-6 rounded-2xl"><p>Guests</p><h2 id="approved-count">0</h2></div>
<div class="glass p-6 rounded-2xl"><p>Pending</p><h2 id="pending-count">0</h2></div>
<div class="glass p-6 rounded-2xl"><p>Refunds</p><h2 id="refund-req-count">0</h2></div>
</div>

<!-- SHOW ANALYTICS -->
<div class="glass p-8 rounded-3xl">
<h2 class="text-xl font-black mb-6">Show Performance</h2>
<div id="show-analytics"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, getDocs, query, where,
  doc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyBDcvXVhv-hn0lTrIxfjrPlp2B5N0Vk_As",
  authDomain: "praxis-tickets.firebaseapp.com",
  projectId: "praxis-tickets"
});

const auth = getAuth(app);
const db = getFirestore(app);
emailjs.init("A9gvj50d9xfwuaCq_");

onAuthStateChanged(auth, user => {
  if (!user || user.email !== "admin@praxis.co") location.href = "index.html";
  loadStats();
  loadShowAnalytics();
  setInterval(autoApproveTickets, 1000);
  setInterval(autoProcessRefunds, 1000);
});

/* ---------------- AUTO APPROVE ---------------- */
async function autoApproveTickets() {
  const q = query(collection(db,"tickets"), where("status","==","pending"));
  const snap = await getDocs(q);
  snap.forEach(async d => {
    const t = d.data();
    await updateDoc(doc(db,"tickets",d.id), { status:"approved" });
    await updateDoc(doc(db,"events",t.eventDocId), {
      ticketCount: increment(t.totalEntries || 1)
    });
  });
}

/* ---------------- AUTO REFUND ---------------- */
async function autoProcessRefunds() {
  const q = query(collection(db,"tickets"), where("status","==","cancel_requested"));
  const snap = await getDocs(q);
  snap.forEach(async d => {
    const t = d.data();
    await updateDoc(doc(db,"tickets",d.id), { status:"refunded" });
    await updateDoc(doc(db,"events",t.eventDocId), {
      ticketCount: increment(-(t.totalEntries || 1))
    });

    await emailjs.send("service_ctg57ig","template_cancellation",{
      to_email:t.buyerEmail,
      event_name:t.eventName,
      ticket_qty:t.totalEntries || 1,
      refund_amount:`₹${t.refundAmount}`,
      cancellation_reason:"Ticket cancelled",
      apology_clause:""
    });
  });
}

/* ---------------- STATS ---------------- */
async function loadStats() {
  const snap = await getDocs(collection(db,"tickets"));
  let rev=0, guests=0, pending=0, refunds=0;
  snap.forEach(d=>{
    const t=d.data();
    if(t.status==="approved"){ rev+=t.price; guests+=t.totalEntries||1 }
    if(t.status==="pending") pending++;
    if(t.status==="cancel_requested") refunds++;
    if(t.status==="refunded") rev+=t.price*0.3;
  });
  total-revenue.innerText=`₹${Math.floor(rev)}`;
  approved-count.innerText=guests;
  pending-count.innerText=pending;
  refund-req-count.innerText=refunds;
}

/* ---------------- ANALYTICS ---------------- */
async function loadShowAnalytics(){
  const evSnap=await getDocs(collection(db,"events"));
  const tkSnap=await getDocs(collection(db,"tickets"));
  show-analytics.innerHTML="";
  evSnap.forEach(e=>{
    let sold=0,rev=0;
    tkSnap.forEach(t=>{
      const d=t.data();
      if(d.eventDocId===e.id){
        if(d.status==="approved"||d.status==="cancel_requested"){sold+=d.totalEntries||1;rev+=d.price}
        if(d.status==="refunded")rev+=d.price*0.3
      }
    });
    show-analytics.innerHTML+=`
    <div class="glass p-6 rounded-xl mb-4">
      <h3>${e.data().title}</h3>
      <p>${sold}/${e.data().maxTickets}</p>
      <p>₹${Math.floor(rev)}</p>
    </div>`;
  });
}
</script>
</body>
</html>
