<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PRAXIS | Gate Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@800&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #000; color: #fff; overflow-x: hidden; }
        h1 { font-family: 'Syne', sans-serif; }
        .glass-nav { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        #qr-reader { border: none !important; }
        #qr-reader__scan_region { display: flex; justify-content: center; }
        #qr-reader video { border-radius: 24px; object-fit: cover !important; }
        /* Professional QR Overlay */
        #qr-reader__dashboard { padding: 20px !important; }
        button { text-transform: uppercase; letter-spacing: 0.1em; font-size: 10px !important; font-weight: 900 !important; }
    </style>
</head>

<body class="min-h-screen flex flex-col bg-black">

    <nav class="glass-nav sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
        <div class="flex flex-col">
            <span class="font-black italic text-xl tracking-tighter leading-none">PRAXIS.</span>
            <span class="text-[8px] uppercase tracking-[0.4em] text-purple-500 font-bold">Gate Access</span>
        </div>
        <a href="admin.html" class="px-5 py-2 border border-white/20 rounded-full text-[9px] font-black uppercase tracking-widest hover:bg-white hover:text-black transition-all">
            Dashboard
        </a>
    </nav>

    <main class="flex-1 flex flex-col max-w-2xl mx-auto w-full">
        <div class="p-6">
            <div class="relative group">
                <div id="qr-reader" class="rounded-[2.5rem] overflow-hidden bg-white/5 border border-white/10"></div>
                <div class="absolute inset-0 pointer-events-none border-[2px] border-purple-500/20 rounded-[2.5rem]"></div>
            </div>
        </div>

        <div class="px-6 pb-10">
            <div id="result-box" class="p-8 rounded-[2.5rem] text-center hidden transition-all duration-300 transform scale-95 border">
                <p id="result-msg" class="font-black italic text-4xl uppercase tracking-tighter"></p>
                <p id="result-detail" class="text-[10px] font-bold opacity-70 mt-3 uppercase tracking-widest leading-relaxed"></p>
            </div>

            <div id="idle-msg" class="text-center py-10">
                <div class="animate-pulse mb-4 flex justify-center">
                    <div class="w-2 h-2 rounded-full bg-purple-500"></div>
                </div>
                <p class="text-[10px] opacity-30 font-black uppercase tracking-[0.3em]">Waiting for QR Code</p>
            </div>
        </div>
    </main>

    <footer class="p-6 text-center border-t border-white/5">
        <p class="text-[8px] opacity-20 uppercase font-bold tracking-widest">Authorized Personnel Only • v2.1</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDcvXVhv-hn0lTrIxfjrPlp2B5N0Vk_As",
            authDomain: "praxis-tickets.firebaseapp.com",
            projectId: "praxis-tickets",
            storageBucket: "praxis-tickets.firebasestorage.app",
            messagingSenderId: "865044869844",
            appId: "1:865044869844:web:7fe4fc422d158f5c2c0141"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (!user || user.email !== "admin@praxis.co") {
                alert("ACCESS DENIED");
                location.href = "index.html";
            }
        });

        const scanner = new Html5Qrcode("qr-reader");
        let canScan = true;

        const config = { 
            fps: 20, // Faster tracking
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0 
        };

        scanner.start(
            { facingMode: "environment" },
            config,
            async (text) => {
                if (!canScan) return;
                canScan = false;
                await validateTicket(text);
                setTimeout(() => { 
                    canScan = true; 
                    document.getElementById("result-box").classList.add("hidden");
                    document.getElementById("idle-msg").classList.remove("hidden");
                }, 3500);
            }
        );

        async function validateTicket(ticketId) {
            const box = document.getElementById("result-box");
            const idle = document.getElementById("idle-msg");
            
            idle.classList.add("hidden");
            box.classList.remove("hidden");

            try {
                const ref = doc(db, "tickets", ticketId);
                const snap = await getDoc(ref);

                if (!snap.exists()) {
                    show("INVALID", "Ticket ID not found in database", "border-red-500/50 bg-red-500/10 text-red-500");
                    return;
                }

                const data = snap.data();
                
                if (data.status !== "approved") {
                    show("DENIED", "Order is pending or rejected", "border-yellow-500/50 bg-yellow-500/10 text-yellow-500");
                }
                else if (data.isUsed) {
                    show("ALREADY USED", `Checked in at: ${new Date(data.usedAt || Date.now()).toLocaleTimeString()}`, "border-orange-500/50 bg-orange-500/10 text-orange-500");
                }
                else {
                    await updateDoc(ref, { 
                        isUsed: true,
                        usedAt: Date.now() 
                    });
                    show("CLEAR TO ENTER", `${data.eventName} • ${data.tier || 'Standard'}`, "border-green-500/50 bg-green-500/10 text-green-400");
                }
            } catch (e) {
                show("SYSTEM ERROR", e.message, "border-red-500/50 bg-red-500/10 text-red-500");
            }
        }

        function show(title, text, colorClass) {
            const box = document.getElementById("result-box");
            box.className = `p-8 rounded-[2.5rem] text-center transition-all duration-300 scale-100 ${colorClass}`;
            document.getElementById("result-msg").innerText = title;
            document.getElementById("result-detail").innerText = text;
            
            // Haptic Feedback if supported
            if (window.navigator.vibrate) window.navigator.vibrate(100);
        }
    </script>
</body>
</html>
