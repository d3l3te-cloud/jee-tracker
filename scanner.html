<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PRAXIS | GATE ENTRY SCANNER</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- QR Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@800&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background: #000; color: white; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-6">

<div class="glass w-full max-w-md p-8 rounded-[3rem] text-center">

    <h1 class="font-black text-3xl italic tracking-tighter mb-2">GATE ENTRY</h1>
    <p class="text-[10px] opacity-40 uppercase tracking-[0.3em] mb-6">
        Live QR Scanner
    </p>

    <!-- CAMERA -->
    <div id="qr-reader" class="rounded-2xl overflow-hidden mb-6"></div>

    <!-- STATUS -->
    <div id="result-box" class="hidden p-6 rounded-2xl">
        <p id="result-msg" class="font-black uppercase italic text-sm"></p>
        <p id="result-detail" class="text-[10px] opacity-60 mt-2 uppercase"></p>
    </div>

    <p class="text-[10px] opacity-30 mt-6 uppercase">
        Ready for next scan
    </p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    /* ================= FIREBASE CONFIG ================= */

    const firebaseConfig = {
        apiKey: "AIzaSyBDcvXVhv-hn0lTrIxfjrPlp2B5N0Vk_As",
        authDomain: "praxis-tickets.firebaseapp.com",
        projectId: "praxis-tickets",
        storageBucket: "praxis-tickets.firebasestorage.app",
        messagingSenderId: "865044869844",
        appId: "1:865044869844:web:7fe4fc422d158f5c2c0141"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    /* ================= ADMIN CHECK ================= */

    onAuthStateChanged(auth, (user) => {
        if (!user || user.email !== "admin@praxis.co") {
            alert("Unauthorized");
            window.location.href = "index.html";
        }
    });

    /* ================= QR SCANNER ================= */

    const scanner = new Html5Qrcode("qr-reader");
    let scanning = true;

    startScanner();

    function startScanner() {
        scanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            async (decodedText) => {
                if (!scanning) return;

                scanning = false;
                await validateTicket(decodedText);

                // Resume scanning after delay
                setTimeout(() => {
                    scanning = true;
                }, 2000);
            },
            () => {}
        );
    }

    /* ================= VALIDATION ================= */

    async function validateTicket(ticketId) {
        const box = document.getElementById("result-box");
        const msg = document.getElementById("result-msg");
        const detail = document.getElementById("result-detail");

        box.classList.remove("hidden");

        try {
            const ref = doc(db, "tickets", ticketId);
            const snap = await getDoc(ref);

            if (!snap.exists()) {
                show("ERROR", "Ticket Not Found", "bg-red-500/20 text-red-400");
                return;
            }

            const data = snap.data();
            const expired = new Date(data.eventDate) < new Date();

            if (data.status !== "approved") {
                show("DENIED", "Payment Not Approved", "bg-yellow-500/20 text-yellow-400");
            }
            else if (data.isUsed) {
                show("USED", "Already Checked-In", "bg-orange-500/20 text-orange-400");
            }
            else if (expired) {
                show("EXPIRED", "Event Date Passed", "bg-gray-500/20 text-gray-400");
            }
            else {
                await updateDoc(ref, { isUsed: true });

                show(
                    "SUCCESS",
                    `${data.eventName} â€¢ ${data.class}`,
                    "bg-green-500/20 text-green-400"
                );
            }

        } catch (err) {
            show("ERROR", err.message, "bg-red-500/20 text-red-400");
        }
    }

    function show(title, text, color) {
        const box = document.getElementById("result-box");
        box.className = `p-6 rounded-2xl ${color}`;
        document.getElementById("result-msg").innerText = title;
        document.getElementById("result-detail").innerText = text;
    }
</script>

</body>
</html>
