<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PRAXIS | Gate Scanner</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@800&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  body { font-family: 'Inter', sans-serif; background:#000; color:#fff; }
</style>
</head>

<body class="min-h-screen flex flex-col">

<!-- HEADER -->
<header class="p-4 text-center">
  <h1 class="font-black italic text-2xl tracking-tight">GATE ENTRY</h1>
  <p class="text-[10px] opacity-40 uppercase tracking-[0.3em]">
    Mobile Scanner
  </p>
</header>

<!-- CAMERA -->
<div class="flex-1 px-4">
  <div id="qr-reader" class="rounded-3xl overflow-hidden w-full h-[60vh] bg-black"></div>
</div>

<!-- RESULT -->
<div id="result-box"
     class="mx-4 mb-6 p-6 rounded-3xl text-center hidden">
  <p id="result-msg" class="font-black italic text-3xl uppercase"></p>
  <p id="result-detail" class="text-xs opacity-70 mt-2 uppercase"></p>
</div>

<p class="text-center text-[10px] opacity-30 pb-4 uppercase">
  Scan next ticket
</p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBDcvXVhv-hn0lTrIxfjrPlp2B5N0Vk_As",
  authDomain: "praxis-tickets.firebaseapp.com",
  projectId: "praxis-tickets",
  storageBucket: "praxis-tickets.firebasestorage.app",
  messagingSenderId: "865044869844",
  appId: "1:865044869844:web:7fe4fc422d158f5c2c0141"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ===== ADMIN CHECK ===== */
onAuthStateChanged(auth, (user) => {
  if (!user || user.email !== "admin@praxis.co") {
    alert("Unauthorized");
    location.href = "index.html";
  }
});

/* ===== QR SCANNER ===== */
const scanner = new Html5Qrcode("qr-reader");
let canScan = true;

scanner.start(
  { facingMode: "environment" },
  { fps: 12, qrbox: { width: 260, height: 260 } },
  async (text) => {
    if (!canScan) return;
    canScan = false;

    await validateTicket(text);

    setTimeout(() => {
      canScan = true;
    }, 2500); // delay before next scan
  }
);

/* ===== VALIDATION ===== */
async function validateTicket(ticketId) {
  const box = document.getElementById("result-box");
  const msg = document.getElementById("result-msg");
  const detail = document.getElementById("result-detail");

  box.classList.remove("hidden");

  try {
    const ref = doc(db, "tickets", ticketId);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      show("ERROR", "Ticket Not Found", "bg-red-500/20 text-red-400");
      return;
    }

    const data = snap.data();
    const expired = new Date(data.eventDate) < new Date();

    if (data.status !== "approved") {
      show("DENIED", "Payment Not Approved", "bg-yellow-500/20 text-yellow-400");
    }
    else if (data.isUsed) {
      show("USED", "Already Checked In", "bg-orange-500/20 text-orange-400");
    }
    else if (expired) {
      show("EXPIRED", "Event Ended", "bg-gray-500/20 text-gray-400");
    }
    else {
      await updateDoc(ref, { isUsed: true });

      show(
        "APPROVED",
        `${data.eventName} â€¢ ${data.class}`,
        "bg-green-500/20 text-green-400"
      );
    }
  } catch (e) {
    show("ERROR", e.message, "bg-red-500/20 text-red-400");
  }
}

/* ===== UI ===== */
function show(title, text, color) {
  const box = document.getElementById("result-box");
  box.className = `mx-4 mb-6 p-6 rounded-3xl text-center ${color}`;
  document.getElementById("result-msg").innerText = title;
  document.getElementById("result-detail").innerText = text;
}
</script>

</body>
</html>
